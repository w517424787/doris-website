<!doctype html>
<html lang="zh-Hans-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<meta name="generator" content="Docusaurus v2.4.1">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Apache Doris RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Apache Doris Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DT7W9E9722"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DT7W9E9722",{anonymize_ip:!0})</script>






<link rel="icon" href="/zh-CN/images/logo-only.png">
<link rel="manifest" href="/zh-CN/manifest.json">
<meta name="theme-color" content="#FFFFFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/zh-CN/img/docusaurus.png">
<link rel="mask-icon" href="/zh-CN/img/docusaurus.svg" color="rgb(37, 194, 160)">
<meta name="msapplication-TileImage" content="/zh-CN/img/docusaurus.png">
<meta name="msapplication-TileColor" content="#000">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:500">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:400"><title data-rh="true">Apache Doris 在蔚来汽车的应用 - Apache Doris</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doris.apache.org/zh-CN/blog/NIO"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Apache Doris 在蔚来汽车的应用 - Apache Doris"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-28T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="最佳实践"><link data-rh="true" rel="icon" href="/zh-CN/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://doris.apache.org/zh-CN/blog/NIO"><link data-rh="true" rel="alternate" href="https://doris.apache.org/blog/NIO" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://doris.apache.org/zh-CN/blog/NIO" hreflang="zh-Hans-CN"><link data-rh="true" rel="alternate" href="https://doris.apache.org/blog/NIO" hreflang="x-default"><link rel="stylesheet" href="https://cdnd.selectdb.com/zh-CN/assets/css/styles.ac96d32f.css">
<link rel="preload" href="https://cdnd.selectdb.com/zh-CN/assets/js/runtime~main.94023cf9.js" as="script">
<link rel="preload" href="https://cdnd.selectdb.com/zh-CN/assets/js/main.b2574faa.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_s0pr" style="background-color:#3C2FD4;color:#FFFFFF" role="banner"><div class="announcementBarPlaceholder_qxfj"></div><div class="announcementBarContent_dpRF"><a href="https://github.com/apache/doris" target="_blank" style="display: flex; width: 100%; align-items: center; justify-content: center; margin-left: 4px; text-decoration: none; color: white">Do you like Apache Doris？Give us a 🌟 on Github 
                        <img style="width: 1.2rem; height: 1.2rem; margin-left: 0.4rem;" src="/images/github-white-icon.svg">
                    </a></div><button type="button" class="clean-btn close announcementBarClose_iXyO" aria-label="关闭"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Doris" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Doris" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/zh-CN/">首页</a><a class="navbar__item navbar__link" href="/zh-CN/docs/dev/summary/basic-summary">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-CN/blog">博客</a><a class="navbar__item navbar__link" href="/zh-CN/community/team">社区</a><a class="navbar__item navbar__link" href="/zh-CN/users">用户</a></div><div class="navbar__items navbar__items--right"><div class="versions">版本<!-- -->:<div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh-CN/docs/dev/get-starting/">dev</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-CN/docs/dev/get-starting/">dev</a></li><li><a class="dropdown__link" href="/zh-CN/docs/1.2/get-starting/">1.2</a></li></ul></div></div><div class="locale-box"><a href="/blog/NIO" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">EN</a><a href="/zh-CN/blog/NIO" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link dropdown__link--active">中文</a></div><a class="navbar__item navbar__link header-right-button-primary navbar-download-mobile" href="/zh-CN/download">下载</a><div class="navbar-search searchBox_ZlJk"><div class="navbar__search searchBarContainer_PzyC"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing__K5d searchBarLoadingRing_e2f0"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_m7ml"><kbd class="searchHint_zuPL">ctrl</kbd><kbd class="searchHint_zuPL">K</kbd></div></div></div><span class="github-btn desktop header-right-button-github"><span class="github-btn github-btn-large"><a class="gh-btn" href="//github.com/apache/doris/" target="_blank"><span class="gh-ico" aria-hidden="true"></span><span class="gh-text">Star</span></a><a class="gh-count" target="_blank" href="//github.com/apache/doris/stargazers/"></a></span></span><a class="header-right-button-primary navbar-download-desktop" href="/zh-CN/download">下载</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="main-wrapper"><div class="container margin-vert--lg blog-container"><div class="row"><main class="col col--9 col--offset-1" itemscope="" itemtype="http://schema.org/Blog"><article class="blog-article-content" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blog-post-title" itemprop="headline">Apache Doris 在蔚来汽车的应用</h1><div class="blog-info"><time datetime="2022-11-28T00:00:00.000Z" itemprop="datePublished">2022年11月28日</time><span class="split-line"></span><span class="authors"><span class="s-author">唐怀东</span></span><span class="split-line"></span><span class="s-tags"><span class="s-tag">最佳实践</span></span></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h1>Apache Doris 在蔚来汽车的应用</h1><p><img loading="lazy" alt="NIO" src="https://cdnd.selectdb.com/zh-CN/assets/images/NIO_kv-7601d71a49c7ecd7fb42f03de600ae6c.png" width="900" height="383" class="img_ev3q"></p><blockquote><p>导读：本次分享的题目是Apache Doris在蔚来汽车的应用，主要包括以下几大部分：</p><ol><li>蔚来</li><li>OLAP在蔚来的发展</li><li>Doris作为统一OLAP数仓</li><li>Doris在运营平台上的实践</li><li>经验总结</li></ol></blockquote><p>作者：唐怀东，蔚来汽车 数据团队负责人</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="蔚来">蔚来<a href="#蔚来" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>蔚来（纽约证券交易所代码：NIO）是设计高端智能电动汽车市场的领先公司。 NIO 成立于 2014 年 11 月，设计、开发、联合制造和销售高端智能电动汽车，并不断推动自动驾驶、数字技术、电动动力总成和电池领域的创新。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="olap在蔚来的发展">OLAP在蔚来的发展<a href="#olap在蔚来的发展" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>首先，让我们来一起回顾OLAP在蔚来汽车的发展。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-2017年引入apache-druid">1. 2017年引入Apache Druid<a href="#1-2017年引入apache-druid" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>在当时可选择的OLAP存储和查询引擎并不多，比较常见的有Apache Druid、Apache Kylin。我们优先引入Druid的原因是以前有使用经验，而Kylin预计算虽然具有极高的查询效率优势，但是：</p><ul><li><p>Kylin底层最合适和最优的存储是HBase，之前公司并未引入，会额外增加运维的工作。</p></li><li><p>Kylin对各种维度和指标进行预计算，如果维度和维度取值非常多，会有维度爆炸的问题，对存储造成非常大的压力。</p></li></ul><p>Druid的优势很明显，支持实时和离线数据接入，列式存储，高并发，查询效率非常高。其缺点也比较明显：</p><ul><li>未使用标准协议例如JDBC，使用门槛高</li><li>Join的支持较弱</li><li>精确去重的效率低，性能会随之下降。整体性能要分场景去考虑，这也是我们后期去选型其他OLAP的原因</li><li>运维成本高，不同的组件有不同的安装方式和不同的依赖；数据导入还要考虑和Hadoop集成以及JAR包的依赖</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-2019年引入tidb">2. 2019年引入TiDB<a href="#2-2019年引入tidb" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><strong>TiDB是一个OLTP+OLAP的成熟引擎，同样是优点、缺点分明：</strong></p><p>优势：</p><ul><li>OLTP数据库，更新友好。</li><li>支持明细和聚合，有指标计算和数据看板展示，还支持明细数据查询</li><li>支持标准SQL，使用成本低</li><li>运维成本低</li></ul><p>劣势：</p><ul><li>它不是一个独立的OLAP。TiFlash依赖于OLTP，会增加存储。其OLAP能力稍显不足</li><li>整体性能要分场景去衡量</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-2021年引入doris">3. 2021年引入Doris<a href="#3-2021年引入doris" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>自2021年起，我们正式引入了Apache Doris。在系统选型过程中，产品的性能、SQL语法、系统兼容性、学习以及运维成本等多方面因素是我们最为关心的部分。经过深入调研、层层对比以下几个系统后，我们得出了如下结论：</p><p><strong>我们重点关注的Doris，其优点完全满足我们的诉求：</strong></p><ul><li>支持高并发查询（我们最关心的一点）</li><li>同时支持实时和离线数据</li><li>支持明细和聚合</li><li>Uniq模型支持更新</li><li>物化视图的能力能极大的加速查询效率</li><li>兼容MySQL协议，所以开发和使用成本比较低</li><li>性能完全满足我们的要求</li><li>运维成本比较低</li></ul><p><strong>Clickhouse，我们之前也调研过，也尝试想去使用它。其单机性能极强，但是缺点明显:</strong></p><ul><li>我们明确需要的场景下，它的多表join支持的稍微差一些</li><li>并发度比较低</li><li>运维成本极高</li></ul><p>凭借多种性能优势，Apache Doris比较理想地替代了Druid和TiDB。而Clickhouse在我们的业务上并不能很好的适配，让我们最终走向了Apache Doris。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="doris作为统一olap数仓">Doris作为统一OLAP数仓<a href="#doris作为统一olap数仓" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p><img loading="lazy" alt="NIO" src="https://cdnd.selectdb.com/zh-CN/assets/images/olap-96ad3bb86cebd92a200a0581f0418d3c.png" width="1018" height="669" class="img_ev3q"></p><p>这张图基本上就是从数据源到数据接入、数据计算、数据仓库、数据服务以及应用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-数据源">1. 数据源<a href="#1-数据源" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>蔚来的场景下，数据源不仅仅指业务系统的数据，还有埋点数据、设备数据、车辆数据等等。数据会通过一种接入方式接入到大数据平台。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-数据接入">2. 数据接入<a href="#2-数据接入" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>对于一些业务系统的数据，可以开启CDC捕捉变化的数据，然后转换成一个数据流存储到Kafka，接续再进行流式的计算。某些只能通过批量的方式的数据会直接进入到我们的分布式存储。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-数据计算">3. 数据计算<a href="#3-数据计算" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>我们没有采用流批一体，采用的是Lambda架构。
我们本身的业务决定了我们的Lambda架构是离线和实时分成了两条路径：</p><ul><li>部分数据是流式的。</li><li>部分数据能够存储到数据流里，一些历史数据不会存储到Kafka。</li><li>有些场景数据要求高精准度。为了保证数据的准确性，一个离线的pipeline将会把整个数据重新计算和刷新。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-数据仓库">4. 数据仓库<a href="#4-数据仓库" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>数据计算到数仓，这两条线路我们没有采用Flink或Spark Doris Connector。我们用Routine Load来连接Apache Doris和Flink，用Broker Load连接Doris和Spark。 由Spark批量生成的数据，会备份到Hive供其他场景使用。这样每计算一次，就同时供多个场景去使用，大大提升了效率。Flink的情况也诸如此类。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-数据服务">5. 数据服务<a href="#5-数据服务" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>Doris后面是One Service。通过注册数据源或灵活配置的方式，自动生成API，对API进行流量的控制和权限的控制，灵活性大大提高。并借助于k8s serverless方案，整个服务非常灵活和丰富。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-数据应用">6. 数据应用<a href="#6-数据应用" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>应用层中我们主要是部署一些报表应用和其他的一些服务。</p><p>我们主要有两类使用场景：</p><ul><li>面向用户，类似于互联网，我们有很多用户的场景，包括看板和指标</li><li>面向车，车的数据通过这种方式进入到Doris，通过一定的聚合之后，Doris数据体量在几十亿级别。但总体性能仍然可以满足我们的要求。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="doris在运营平台上的实践">Doris在运营平台上的实践<a href="#doris在运营平台上的实践" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-cdp-architecture">1. CDP Architecture<a href="#1-cdp-architecture" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="NIO" src="https://cdnd.selectdb.com/zh-CN/assets/images/cdp-3d65926e741a2837759b07514e914bbf.png" width="1471" height="422" class="img_ev3q"></p><p>接下来我来介绍Doris在运营平台上的实践。这是我们的真实使用场景。如今互联网公司普遍会做自己的CDP，它一般包括几个模块：</p><ul><li>标签，是最基础的部分。</li><li>圈人，基于标签，按照一定逻辑将人圈选出来。</li><li>洞察，针对圈定的人群，了解人群分布、特点。</li><li>触达，利用例如短信、电话、声音、APP通知、IM等方式触达到用户，并配合流量控制。</li><li>效果分析，提升运营平台的完整性，有动作、有效果、有反馈。</li></ul><p>Doris在这里面起到了最重要的作用，包括：标签存储、人群存储、效果分析。
标签分为基础标签和用户行为的基础数据，在此基础之上，我们可以灵活自定义其他标签。从实效性来看，标签还分为实时的标签和离线的标签。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-cdp存储选型的考量点">2. CDP存储选型的考量点<a href="#2-cdp存储选型的考量点" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>我们从5个维度去考量CDP存储的选型。</p><p>**(1) 离线和实时统一
如前所述标签有离线标签，有实时标签。目前我们是准实时的场景。对于有些数据，准实时已足够满足我们的需求，大量的标签还是离线的标签，采用的方式就是Doris的Routine Load和Broker Load。</p><table><thead><tr><th><strong>场景</strong></th><th><strong>需求</strong></th><th><strong>Apache Doris功能点</strong></th></tr></thead><tbody><tr><td>实时标签</td><td>数据实时更新</td><td>Routine Load</td></tr><tr><td>离线标签</td><td>高效大批量导入</td><td>Broker Load</td></tr><tr><td>流批统一</td><td>实时历险数据存储统一</td><td>Routine Load 和 Broker Load 更新同一张表的不同列</td></tr></tbody></table><p>另外同一张表上，不同列更新的频率也是不一样的。例如用户的基础标签，我们对用户的身份需要实时的更新，因为用户的身份是时刻变化的。T+1的更新不能满足我们的需求。有些标签离线，例如用户的性别、年龄等基础标签，T+1更新足以满足我们的标准。基础用户的原子标签放在一张表中带来的维护成本很低。当后期自定义标签时，表的数量会大大减少，这样对于整体性能的提升有极大好处。</p><p><strong>(2) 高效圈选</strong></p><p>用户运营有了标签，第二步就是圈人，圈选就是根据标签的不同组合，把符合标签条件的所有人筛选出来，这时会有不同标签条件组合的查询、这个查询在Doris引入向量化之后有比较明显的提升。</p><table><thead><tr><th><strong>场景</strong></th><th><strong>需求</strong></th><th><strong>Apache Doris功能点</strong></th></tr></thead><tbody><tr><td>复杂条件圈选</td><td>高效的支持多条件圈选</td><td>SIMD的优化</td></tr></tbody></table><p><strong>(3) 高效聚合</strong></p><p>前面提到的用户洞察或群体洞察以及效果分析统计，需要对数据做统计分析，并不是单一的按用户ID获取标签的这种简单场景。其读取的数据量和查询效率，对我们这个标签的分布、群体的分布、效果分析的统计都有很大的影响。在这里，体现到的Doris的功能特点是：</p><ul><li>第一是数据分片，我们按时间把数据分片，分析统计就会极大的减少数据量，可以极大的加速查询和分析的效率。</li><li>第二是节点聚合，然后再收集做统一的聚合。</li><li>第三是向量化加速，向量化引擎对性能提升非常显著。</li></ul><table><thead><tr><th><strong>场景</strong></th><th><strong>需求</strong></th><th><strong>Apache Doris功能点</strong></th></tr></thead><tbody><tr><td>标签值的分布</td><td>每天都需要更新所有标签，需要快速高效统计</td><td>数据分片，减少数据传输和计算</td></tr><tr><td>群体的分布</td><td>同上</td><td>存算统一，每个节点先聚合</td></tr><tr><td>效果分析的统计值</td><td>同上</td><td>SIMD提速</td></tr></tbody></table><p><strong>(4) 多表关联</strong></p><p>我们的CDP可能和业内常见的CDP场景不太一样，因为有些场景的CDP标签是提前预估完成的，不存在自定义标签。只做原子标签，或者说用户基础行为数据的统计，这样可以把灵活性留给使用CDP的用户，根据自己的业务场景去自定义标签。底层的数据是分散在不同的数据库表里，如果做自定义的标签的建设，势必需要做表的关联。
我们选择Doris一个非常重要的原因，就是多表关联的能力。通过性能测试，Doris目前能够满足我们的要求。而且Doris为用户提供了非常强大的能力。因为标签是动态的。</p><table><thead><tr><th><strong>场景</strong></th><th><strong>需求</strong></th><th><strong>Apache Doris功能点</strong></th></tr></thead><tbody><tr><td>群体的特征分布</td><td>统计群体在某个特征下的分布</td><td>多表关联</td></tr><tr><td>Single Tag</td><td>Display tags</td><td></td></tr></tbody></table><p><strong>(5) 联邦查询</strong></p><p>用户触达成功与否我们会记录到TiDB。用户运营中的通知，可能只影响用户体验，如果涉及到钱例如发放积分或优惠券，任务执行就要做到不重不漏，这种OLTP场景用TiDB比较合适。
做效果分析，需要了解运营计划执行到什么程度，是否达成目标，其分布情况等等。需要把任务执行情况和人群圈选相结合才能进行分析，就会用到Doris和TiDB的关联，外表关联进行查询。
我们设想标签体量比较小，保存到es可能比较合适，然而ES不能满足我们的需求，后面会解释其原因。</p><table><thead><tr><th><strong>场景</strong></th><th><strong>需求</strong></th><th><strong>Apache Doris功能点</strong></th></tr></thead><tbody><tr><td>效果分析关联任务执行明细</td><td>Doris数据关联TiDB数据</td><td>关联外表进行查询</td></tr><tr><td>人群标签关联行为聚合数据</td><td>Doris数据关联Elasticsearch数据</td><td></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="经验和总结">经验和总结<a href="#经验和总结" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><ol><li><p><strong>bitmap</strong>. 我们的体量无法充分发挥其效率。如果体量达到一定程度，用bitmap会有很好的性能提升。例如计算UV场景，Id全集大于5000万，可以考虑bitmap聚合。</p></li><li><p><strong>ES外表。单表查询下效率比较理想。</strong> </p></li><li><p><strong>分批更新列</strong>. 为了减少表的数量和提升join表的性能，设计表尽量精简尽量聚合，相同类型的事实都放在一起。但相同类型的字段可能更新频率不同，有些字段需要天级更新，有些字段可能需要小时级更新，单独更新某一列就是一个明显的诉求。Doris聚合模型单独更新某些列的解决方案是使用REPLACE_IF_NOT_NULL。注意:用null替换原来的非null值是做不到的,可以把所有的null替换成有意义的默认值，例如unknown。</p></li><li><p><strong>在线服务</strong>. Doris同一份数据同时服务在线离线场景，对资源隔离的要求比较高，目前还存在进一步优化的空间。</p></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-CN/blog/Netease"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Apache Doris 助力网易严选打造精细化运营 DMP 标签系统</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-CN/blog/ssb"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Apache Doris 1.2 Star-Schema-Benchmark 性能测试报告</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#蔚来" class="table-of-contents__link toc-highlight">蔚来</a></li><li><a href="#olap在蔚来的发展" class="table-of-contents__link toc-highlight">OLAP在蔚来的发展</a><ul><li><a href="#1-2017年引入apache-druid" class="table-of-contents__link toc-highlight">1. 2017年引入Apache Druid</a></li><li><a href="#2-2019年引入tidb" class="table-of-contents__link toc-highlight">2. 2019年引入TiDB</a></li><li><a href="#3-2021年引入doris" class="table-of-contents__link toc-highlight">3. 2021年引入Doris</a></li></ul></li><li><a href="#doris作为统一olap数仓" class="table-of-contents__link toc-highlight">Doris作为统一OLAP数仓</a><ul><li><a href="#1-数据源" class="table-of-contents__link toc-highlight">1. 数据源</a></li><li><a href="#2-数据接入" class="table-of-contents__link toc-highlight">2. 数据接入</a></li><li><a href="#3-数据计算" class="table-of-contents__link toc-highlight">3. 数据计算</a></li><li><a href="#4-数据仓库" class="table-of-contents__link toc-highlight">4. 数据仓库</a></li><li><a href="#5-数据服务" class="table-of-contents__link toc-highlight">5. 数据服务</a></li><li><a href="#6-数据应用" class="table-of-contents__link toc-highlight">6. 数据应用</a></li></ul></li><li><a href="#doris在运营平台上的实践" class="table-of-contents__link toc-highlight">Doris在运营平台上的实践</a><ul><li><a href="#1-cdp-architecture" class="table-of-contents__link toc-highlight">1. CDP Architecture</a></li><li><a href="#2-cdp存储选型的考量点" class="table-of-contents__link toc-highlight">2. CDP存储选型的考量点</a></li></ul></li><li><a href="#经验和总结" class="table-of-contents__link toc-highlight">经验和总结</a></li></ul></div></div></div></div></div></div><div class="footer"><div class="container"><div class="footer-box"><div class="left"><img src="/zh-CN/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh-CN/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/download">下载</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/learning">文档</a></li></ul></div><div class="col footer__col"><div class="footer__title">ASF</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">基金会<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">版权<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">活动<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">捐赠<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">隐私<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">鸣谢<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">语言</div><ul class="footer__items clean-list"><li class="footer__item"><a href="/blog/NIO" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link footer__link-item">English</a></li><li class="footer__item"><a href="/zh-CN/blog/NIO" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link footer__link-item">简体中文</a></li></ul></div></div></div><div class="right"><div class="footer__title">分享</div><div class="social-list"><div class="social"><a href="mailto:dev@doris.apache.org" title="mail" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.6003 6H26.3997C27.8186 6 28.982 7.10964 29 8.46946L16.0045 15.454L3.01202 8.47829C3.02405 7.11258 4.1784 6 5.6003 6ZM3.01202 11.1508L3 23.5011C3 24.8756 4.16938 26 5.6003 26H26.3997C27.8306 26 29 24.8756 29 23.5011V11.145L16.3111 17.8028C16.1157 17.9058 15.8813 17.9058 15.6889 17.8028L3.01202 11.1508V11.1508Z" fill="currentColor"></path></svg></a><a href="https://github.com/apache/doris" title="github" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.0001 2.66675C8.63342 2.66675 2.66675 8.63341 2.66675 16.0001C2.66524 18.7991 3.54517 21.5276 5.1817 23.7983C6.81824 26.0691 9.12828 27.7668 11.7841 28.6508C12.4508 28.7668 12.7001 28.3668 12.7001 28.0161C12.7001 27.7001 12.6828 26.6508 12.6828 25.5334C9.33342 26.1508 8.46675 24.7174 8.20008 23.9668C8.04942 23.5828 7.40008 22.4001 6.83342 22.0828C6.36675 21.8334 5.70008 21.2161 6.81608 21.2001C7.86675 21.1828 8.61608 22.1668 8.86675 22.5668C10.0668 24.5828 11.9841 24.0161 12.7494 23.6668C12.8668 22.8001 13.2161 22.2174 13.6001 21.8841C10.6334 21.5508 7.53342 20.4001 7.53342 15.3001C7.53342 13.8494 8.04942 12.6507 8.90008 11.7161C8.76675 11.3827 8.30008 10.0161 9.03342 8.18275C9.03342 8.18275 10.1494 7.83342 12.7001 9.55075C13.7855 9.2495 14.907 9.09787 16.0334 9.10008C17.1668 9.10008 18.3001 9.24942 19.3668 9.54942C21.9161 7.81608 23.0334 8.18408 23.0334 8.18408C23.7668 10.0174 23.3001 11.3841 23.1668 11.7174C24.0161 12.6507 24.5334 13.8334 24.5334 15.3001C24.5334 20.4174 21.4174 21.5508 18.4508 21.8841C18.9334 22.3001 19.3508 23.1001 19.3508 24.3508C19.3508 26.1334 19.3334 27.5668 19.3334 28.0174C19.3334 28.3668 19.5841 28.7828 20.2508 28.6494C22.8975 27.7558 25.1973 26.0547 26.8266 23.7856C28.4559 21.5165 29.3327 18.7936 29.3334 16.0001C29.3334 8.63341 23.3668 2.66675 16.0001 2.66675V2.66675Z" fill="currentColor"></path></svg></a><a href="https://twitter.com/doris_apache" title="twitter" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M27.1493 10.8313C27.1493 10.5687 27.1442 10.3091 27.1326 10.0512C28.2554 9.21471 29.2295 8.1676 30 6.96938C28.9537 7.44012 27.8403 7.74469 26.7 7.8721C27.8868 7.14188 28.7969 5.97403 29.227 4.57256C28.1158 5.24638 26.8867 5.72811 25.5798 5.97912C24.5326 4.78777 23.0383 4.02895 21.3864 4.00076C18.2137 3.94831 15.6418 6.62904 15.6418 9.98754C15.6418 10.4649 15.6918 10.9279 15.7909 11.3749C11.0133 11.0675 6.77972 8.58103 3.9478 4.8326C3.45367 5.73067 3.17017 6.78025 3.17017 7.90503C3.17017 10.0324 4.18438 11.9232 5.72536 13.039C4.78198 12.9963 3.89827 12.7106 3.12316 12.2422V12.3204C3.12316 15.2937 5.10395 17.7849 7.73223 18.3661C7.2504 18.5032 6.74218 18.5745 6.2195 18.5719C5.85634 18.57 5.49437 18.5304 5.13941 18.4536C5.86973 20.8902 7.99227 22.6703 10.5051 22.7297C8.53846 24.3601 6.06106 25.334 3.37133 25.3272C2.90757 25.3272 2.44929 25.2961 2 25.2397C4.54329 26.9841 7.56224 28 10.8076 28C21.3719 28.0025 27.1493 18.8084 27.1493 10.8313V10.8313Z" fill="currentColor"></path></svg></a></div><div class="social"><a href="https://join.slack.com/t/apachedoriscommunity/shared_invite/zt-1x7x8fger-F7NoshFQn~djlvGdnEtxUQ" title="slack" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_125_278)"><path d="M12.5875 16.6906C11.0844 16.6906 9.86562 17.9094 9.86562 19.4125V26.2375C9.86562 26.9594 10.1524 27.6517 10.6628 28.1622C11.1733 28.6726 11.8656 28.9594 12.5875 28.9594C13.3094 28.9594 14.0017 28.6726 14.5122 28.1622C15.0226 27.6517 15.3094 26.9594 15.3094 26.2375V19.4531C15.3094 17.9094 14.0906 16.6906 12.5875 16.6906ZM3 19.4531C3 20.175 3.28677 20.8673 3.79722 21.3778C4.30767 21.8882 4.99999 22.175 5.72187 22.175C6.44376 22.175 7.13608 21.8882 7.64653 21.3778C8.15698 20.8673 8.44375 20.175 8.44375 19.4531V16.7312H5.7625C4.25938 16.6906 3 17.9094 3 19.4531ZM12.5875 3C11.8656 3 11.1733 3.28677 10.6628 3.79722C10.1524 4.30767 9.86562 4.99999 9.86562 5.72187C9.86562 6.44376 10.1524 7.13608 10.6628 7.64653C11.1733 8.15698 11.8656 8.44375 12.5875 8.44375H15.3094V5.72187C15.3094 4.21875 14.0906 3 12.5875 3ZM5.72187 15.3094H12.5469C13.2688 15.3094 13.9611 15.0226 14.4715 14.5122C14.982 14.0017 15.2688 13.3094 15.2688 12.5875C15.2688 11.8656 14.982 11.1733 14.4715 10.6628C13.9611 10.1524 13.2688 9.86562 12.5469 9.86562H5.72187C4.99999 9.86562 4.30767 10.1524 3.79722 10.6628C3.28677 11.1733 3 11.8656 3 12.5875C3 13.3094 3.28677 14.0017 3.79722 14.5122C4.30767 15.0226 4.99999 15.3094 5.72187 15.3094ZM26.2375 9.86562C24.7344 9.86562 23.5156 11.0844 23.5156 12.5875V15.3094H26.2375C26.9594 15.3094 27.6517 15.0226 28.1622 14.5122C28.6726 14.0017 28.9594 13.3094 28.9594 12.5875C28.9594 11.8656 28.6726 11.1733 28.1622 10.6628C27.6517 10.1524 26.9594 9.86562 26.2375 9.86562ZM16.6906 5.72187V12.5875C16.6906 13.3094 16.9774 14.0017 17.4878 14.5122C17.9983 15.0226 18.6906 15.3094 19.4125 15.3094C20.1344 15.3094 20.8267 15.0226 21.3372 14.5122C21.8476 14.0017 22.1344 13.3094 22.1344 12.5875V5.72187C22.1344 4.99999 21.8476 4.30767 21.3372 3.79722C20.8267 3.28677 20.1344 3 19.4125 3C18.6906 3 17.9983 3.28677 17.4878 3.79722C16.9774 4.30767 16.6906 4.99999 16.6906 5.72187ZM22.1344 26.2781C22.1344 24.775 20.9156 23.5562 19.4125 23.5562H16.6906V26.2781C16.6906 27 16.9774 27.6923 17.4878 28.2028C17.9983 28.7132 18.6906 29 19.4125 29C20.1344 29 20.8267 28.7132 21.3372 28.2028C21.8476 27.6923 22.1344 27 22.1344 26.2781ZM26.2781 16.6906H19.4125C18.6906 16.6906 17.9983 16.9774 17.4878 17.4878C16.9774 17.9983 16.6906 18.6906 16.6906 19.4125C16.6906 20.1344 16.9774 20.8267 17.4878 21.3372C17.9983 21.8476 18.6906 22.1344 19.4125 22.1344H26.2375C27.7406 22.1344 28.9594 20.9156 28.9594 19.4125C29 17.9094 27.7812 16.6906 26.2781 16.6906Z" fill="currentColor"></path></g><defs><clipPath id="clip0_125_278"><rect width="26" height="26" fill="currentColor" transform="translate(3 3)"></rect></clipPath></defs></svg></a><a href="https://space.bilibili.com/362350065" title="bilibili" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23.0533 11.5412H9.14591C8.72353 11.5412 8.36784 11.8633 8.36784 12.296V21.5162C8.36784 21.9489 8.72349 22.2665 9.14591 22.2665H23.0533C23.4757 22.2665 23.7928 21.949 23.7928 21.5162V12.296C23.7928 11.8633 23.4757 11.5412 23.0533 11.5412ZM10.0928 14.9479L14.0122 14.1975L14.3083 15.6685L10.4284 16.4188L10.0928 14.9479ZM16.1348 19.4301C14.9303 20.7431 13.6667 19.0155 13.6667 19.0155L14.3084 18.6008C14.3084 18.6008 15.1673 20.1508 16.125 18.0973C17.0432 20.0916 18.06 18.6206 18.06 18.6304L18.6426 19.0057C18.6426 19.0057 17.5565 20.7431 16.1348 19.4301ZM21.9498 16.4189L18.06 15.6686L18.3661 14.1976L22.2756 14.948L21.9498 16.4189Z" fill="currentColor"></path><path d="M16 2C8.26801 2 2 8.26805 2 16C2 23.7319 8.26806 30 16 30C23.7319 30 30 23.7319 30 16C30 8.26801 23.732 2 16 2ZM23.3727 24.1329C22.3941 24.1019 22.0644 24.1329 22.0644 24.1329C22.0644 24.1329 21.9923 25.2558 21.0343 25.2764C20.0659 25.2867 19.9216 24.4934 19.8907 24.1947C19.3035 24.1947 12.2467 24.2255 12.2467 24.2255C12.2467 24.2255 12.1231 25.266 11.165 25.266C10.1967 25.266 10.1451 24.4006 10.0833 24.2255C9.45486 24.2255 8.6101 24.2049 8.6101 24.2049C8.6101 24.2049 6.48791 23.7621 6.20978 21.0012C6.24067 18.2402 6.20978 12.7801 6.20978 12.7801C6.20978 12.7801 6.01404 10.2356 8.54836 9.50415C9.33118 9.4733 11.0208 9.46293 12.9781 9.46293L11.1753 7.71159C11.1753 7.71159 10.8971 7.36131 11.371 6.96986C11.8553 6.57846 11.8757 6.73797 12.0406 6.85128C12.2055 6.96456 14.7295 9.45229 14.7295 9.45229H14.3895C15.3579 9.45229 16.3572 9.46799 17.3152 9.46799C17.686 9.09711 19.798 7.02903 19.9422 6.92612C20.107 6.82309 20.1378 6.64927 20.6118 7.04068C21.0857 7.43213 20.8075 7.78309 20.8075 7.78309L19.0459 9.48322C21.4668 9.50386 23.3315 9.51423 23.3315 9.51423C23.3315 9.51423 25.7214 10.0398 25.7833 12.78C25.7524 15.5203 25.7936 21.0319 25.7936 21.0319C25.7936 21.0319 25.6598 23.7104 23.3727 24.1329Z" fill="currentColor"></path></svg></a><a class="item wechat"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.7578 11.5169C21.0708 11.5169 21.3795 11.5398 21.6851 11.573C20.8524 7.73517 16.7052 4.88306 11.9718 4.88306C6.67951 4.88306 2.34412 8.45283 2.34412 12.9854C2.34412 15.6013 3.78679 17.7498 6.19667 19.4161L5.2339 22.2827L8.59917 20.6122C9.80411 20.8478 10.7698 21.0906 11.9718 21.0906C12.2738 21.0906 12.5728 21.0759 12.8703 21.0523C12.682 20.4159 12.5728 19.7485 12.5728 19.0566C12.5728 14.8947 16.1847 11.5169 20.7578 11.5169ZM15.5822 8.9335C16.3072 8.9335 16.7871 9.40601 16.7871 10.1229C16.7871 10.8369 16.3072 11.3153 15.5822 11.3153C14.8601 11.3153 14.1365 10.8369 14.1365 10.1229C14.1365 9.40601 14.8601 8.9335 15.5822 8.9335ZM8.84429 11.3153C8.12218 11.3153 7.3942 10.8368 7.3942 10.1229C7.3942 9.40597 8.12218 8.93346 8.84429 8.93346C9.56559 8.93346 10.0463 9.40597 10.0463 10.1229C10.0463 10.8369 9.56559 11.3153 8.84429 11.3153ZM29.5453 18.9422C29.5453 15.1332 25.6935 12.0285 21.3677 12.0285C16.7871 12.0285 13.1797 15.1332 13.1797 18.9422C13.1797 22.7567 16.7871 25.8547 21.3677 25.8547C22.326 25.8547 23.2932 25.6169 24.2559 25.3777L26.897 26.8086L26.1726 24.4282C28.1056 22.993 29.5453 21.0906 29.5453 18.9422ZM18.7126 17.7498C18.2335 17.7498 17.7499 17.278 17.7499 16.7966C17.7499 16.3219 18.2335 15.8442 18.7126 15.8442C19.4406 15.8442 19.9176 16.3219 19.9176 16.7966C19.9176 17.278 19.4406 17.7498 18.7126 17.7498ZM24.0079 17.7498C23.5324 17.7498 23.0518 17.278 23.0518 16.7966C23.0518 16.3219 23.5324 15.8442 24.0079 15.8442C24.73 15.8442 25.2128 16.3219 25.2128 16.7966C25.2128 17.278 24.73 17.7498 24.0079 17.7498Z" fill="currentColor"></path></svg><div class="wechat-dropdown"><img src="https://cdnd.selectdb.com/zh-CN/assets/images/wechat-31a2eb3bbefef7171acfae2906dc777c.png" alt=""></div></a></div></div></div></div><div class="footer__copyright">Copyright © 2022 The Apache Software Foundation,Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License, Version 2.0</a>. Apache, Doris, Apache Doris, the Apache feather logo and the Apache Doris logo are trademarks of The Apache Software Foundation.</div></div></div></div>
<script src="https://cdnd.selectdb.com/zh-CN/assets/js/runtime~main.94023cf9.js"></script>
<script src="https://cdnd.selectdb.com/zh-CN/assets/js/main.b2574faa.js"></script>
</body>
</html>