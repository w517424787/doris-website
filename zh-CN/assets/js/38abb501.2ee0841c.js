"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[49578],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>k});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},p=Object.keys(e);for(n=0;n<p.length;n++)a=p[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)a=p[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),d=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},s=function(e){var t=d(e.components);return n.createElement(i.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,p=e.originalType,i=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),c=d(a),u=r,k=c["".concat(i,".").concat(u)]||c[u]||m[u]||p;return a?n.createElement(k,l(l({ref:t},s),{},{components:a})):n.createElement(k,l({ref:t},s))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var p=a.length,l=new Array(p);l[0]=u;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o[c]="string"==typeof e?e:r,l[1]=o;for(var d=2;d<p;d++)l[d]=a[d];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},48682:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>m,frontMatter:()=>p,metadata:()=>o,toc:()=>d});var n=a(87462),r=(a(67294),a(3905));const p={title:"\u8c03\u8bd5\u5de5\u5177",language:"zh-CN"},l=void 0,o={unversionedId:"developer-guide/debug-tool",id:"developer-guide/debug-tool",title:"\u8c03\u8bd5\u5de5\u5177",description:"\x3c!--",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs-community/current/developer-guide/debug-tool.md",sourceDirName:"developer-guide",slug:"/developer-guide/debug-tool",permalink:"/zh-CN/community/developer-guide/debug-tool",draft:!1,tags:[],version:"current",frontMatter:{title:"\u8c03\u8bd5\u5de5\u5177",language:"zh-CN"},sidebar:"community",previous:{title:"Doris\u652f\u6301spark\u5bfc\u5165\u8bbe\u8ba1\u6587\u6863",permalink:"/zh-CN/community/design/spark_load"},next:{title:"Doris Docker \u5feb\u901f\u642d\u5efa\u5f00\u53d1\u73af\u5883",permalink:"/zh-CN/community/developer-guide/docker-dev"}},i={},d=[{value:"FE \u8c03\u8bd5",id:"fe-\u8c03\u8bd5",level:2},{value:"BE \u8c03\u8bd5",id:"be-\u8c03\u8bd5",level:2},{value:"\u73af\u5883\u51c6\u5907",id:"\u73af\u5883\u51c6\u5907",level:3},{value:"\u5185\u5b58",id:"\u5185\u5b58",level:3},{value:"\u67e5\u770b\u65e5\u5fd7",id:"\u67e5\u770b\u65e5\u5fd7",level:4},{value:"TCMalloc",id:"tcmalloc",level:6},{value:"JEMALLOC",id:"jemalloc",level:5},{value:"HEAP PROFILE",id:"heap-profile",level:4},{value:"TCMalloc",id:"tcmalloc-1",level:5},{value:"pprof remote server",id:"pprof-remote-server",level:6},{value:"JEMALLOC",id:"jemalloc-1",level:5},{value:"1. runtime heap dump by http",id:"1-runtime-heap-dump-by-http",level:6},{value:"2. jemalloc heap dump profiling",id:"2-jemalloc-heap-dump-profiling",level:5},{value:"3. heap dump by JEMALLOC_CONF",id:"3-heap-dump-by-jemalloc_conf",level:6},{value:"LSAN",id:"lsan",level:4},{value:"ASAN",id:"asan",level:4},{value:"CPU",id:"cpu",level:3},{value:"pprof",id:"pprof",level:4},{value:"perf + flamegragh",id:"perf--flamegragh",level:4}],s={toc:d},c="wrapper";function m(e){let{components:t,...p}=e;return(0,r.kt)(c,(0,n.Z)({},s,p,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u8c03\u8bd5\u5de5\u5177"},"\u8c03\u8bd5\u5de5\u5177"),(0,r.kt)("p",null,"\u5728Doris\u7684\u4f7f\u7528\u3001\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u9700\u8981\u5bf9Doris\u8fdb\u884c\u8c03\u8bd5\u7684\u573a\u666f\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684\u8c03\u8bd5\u5de5\u5177\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6587\u4e2d\u7684\u51fa\u73b0\u7684BE\u4e8c\u8fdb\u5236\u6587\u4ef6\u540d\u79f0 ",(0,r.kt)("inlineCode",{parentName:"strong"},"doris_be"),"\uff0c\u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u4e3a ",(0,r.kt)("inlineCode",{parentName:"strong"},"palo_be"),"\u3002")),(0,r.kt)("h2",{id:"fe-\u8c03\u8bd5"},"FE \u8c03\u8bd5"),(0,r.kt)("p",null,"FE \u662f Java \u8fdb\u7a0b\u3002\u8fd9\u91cc\u53ea\u5217\u4e3e\u4e00\u4e0b\u7b80\u5355\u5e38\u7528\u7684 java \u8c03\u8bd5\u547d\u4ee4\u3002"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u7edf\u8ba1\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u660e\u7ec6"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"jmap -histo:live pid > 1.jmp\n")),(0,r.kt)("p",{parentName:"li"},"\u8be5\u547d\u4ee4\u53ef\u4ee5\u5217\u4e3e\u5b58\u6d3b\u7684\u5bf9\u8c61\u7684\u5185\u5b58\u5360\u7528\u5e76\u6392\u5e8f\u3002\uff08pid \u6362\u6210 FE \u8fdb\u7a0b id\uff09"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"}," num     #instances         #bytes  class name\n----------------------------------------------\n   1:         33528       10822024  [B\n   2:         80106        8662200  [C\n   3:           143        4688112  [Ljava.util.concurrent.ForkJoinTask;\n   4:         80563        1933512  java.lang.String\n   5:         15295        1714968  java.lang.Class\n   6:         45546        1457472  java.util.concurrent.ConcurrentHashMap$Node\n   7:         15483        1057416  [Ljava.lang.Object;\n")),(0,r.kt)("p",{parentName:"li"},"\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u65b9\u6cd5\u67e5\u770b\u76ee\u524d\u5b58\u6d3b\u5bf9\u8c61\u5360\u7528\u7684\u603b\u5185\u5b58\uff08\u5728\u6587\u4ef6\u6700\u540e\uff09\uff0c\u4ee5\u53ca\u5206\u6790\u54ea\u4e9b\u5bf9\u8c61\u5360\u7528\u4e86\u66f4\u591a\u7684\u5185\u5b58\u3002"),(0,r.kt)("p",{parentName:"li"},"\u6ce8\u610f\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u56e0\u6307\u5b9a\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},":live"),"\uff0c\u56e0\u6b64\u4f1a\u89e6\u53d1 FullGC\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u67e5\u770b JVM \u5185\u5b58\u4f7f\u7528"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"jstat -gcutil pid 1000 1000\n")),(0,r.kt)("p",{parentName:"li"},"\u8be5\u547d\u4ee4\u53ef\u4ee5\u6eda\u52a8\u67e5\u770b\u5f53\u524d JVM \u5404\u533a\u57df\u7684\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u3002\uff08pid \u6362\u6210 FE \u8fdb\u7a0b id\uff09"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT\n  0.00   0.00  22.61   3.03  95.74  92.77     68    1.249     5    0.794    2.043\n  0.00   0.00  22.61   3.03  95.74  92.77     68    1.249     5    0.794    2.043\n  0.00   0.00  22.61   3.03  95.74  92.77     68    1.249     5    0.794    2.043\n  0.00   0.00  22.92   3.03  95.74  92.77     68    1.249     5    0.794    2.043\n  0.00   0.00  22.92   3.03  95.74  92.77     68    1.249     5    0.794    2.043\n")),(0,r.kt)("p",{parentName:"li"},"\u5176\u4e2d\u4e3b\u8981\u5173\u6ce8 Old\u533a\uff08O\uff09\u7684\u5360\u7528\u767e\u5206\u6bd4\uff08\u5982\u793a\u4f8b\u4e2d\u4e3a 3%\uff09\u3002\u5982\u679c\u5360\u7528\u8fc7\u9ad8\uff0c\u5219\u53ef\u80fd\u51fa\u73b0 OOM \u6216 FullGC\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6253\u5370 FE \u7ebf\u7a0b\u5806\u6808"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"jstack -l pid > 1.js\n")),(0,r.kt)("p",{parentName:"li"},"\u8be5\u547d\u4ee4\u53ef\u4ee5\u6253\u5370\u5f53\u524d FE \u7684\u7ebf\u7a0b\u5806\u6808\u3002\uff08pid \u6362\u6210 FE \u8fdb\u7a0b id\uff09\u3002"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"-l")," \u53c2\u6570\u4f1a\u540c\u65f6\u68c0\u6d4b\u662f\u5426\u6709\u6b7b\u9501\u3002\u8be5\u65b9\u6cd5\u53ef\u4ee5\u67e5\u770b FE \u7ebf\u7a0b\u8fd0\u884c\u60c5\u51b5\uff0c\u662f\u5426\u6709\u6b7b\u9501\uff0c\u54ea\u91cc\u5361\u4f4f\u4e86\u7b49\u95ee\u9898\u3002"))),(0,r.kt)("h2",{id:"be-\u8c03\u8bd5"},"BE \u8c03\u8bd5"),(0,r.kt)("h3",{id:"\u73af\u5883\u51c6\u5907"},"\u73af\u5883\u51c6\u5907"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/google/pprof"},"pprof"),": \u6765\u81eagperftools\uff0c\u7528\u4e8e\u5c06gperftools\u6240\u4ea7\u751f\u7684\u5185\u5bb9\u8f6c\u5316\u6210\u4fbf\u4e8e\u4eba\u53ef\u4ee5\u9605\u8bfb\u7684\u683c\u5f0f\uff0c\u6bd4\u5982pdf, svg, text\u7b49."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://www.graphviz.org/"},"graphviz"),": \u5728\u6ca1\u6709\u8fd9\u4e2a\u5e93\u7684\u65f6\u5019pprof\u53ea\u53ef\u4ee5\u8f6c\u5316\u4e3atext\u683c\u5f0f\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u4e0d\u6613\u67e5\u770b\u3002\u90a3\u4e48\u5b89\u88c5\u8fd9\u4e2a\u5e93\u540e\uff0cpprof\u53ef\u4ee5\u8f6c\u5316\u4e3asvg\u3001pdf\u7b49\u683c\u5f0f\uff0c\u5bf9\u4e8e\u8c03\u7528\u5173\u7cfb\u5219\u66f4\u52a0\u6e05\u6670\u660e\u4e86\u3002"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://perf.wiki.kernel.org/index.php/Main_Page"},"perf"),": linux\u5185\u6838\u81ea\u5e26\u6027\u80fd\u5206\u6790\u5de5\u5177\u3002",(0,r.kt)("a",{parentName:"p",href:"http://www.brendangregg.com/perf.html"},"\u8fd9\u91cc"),"\u6709\u4e00\u4e9bperf\u7684\u4f7f\u7528\u4f8b\u5b50\u3002"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/brendangregg/FlameGraph"},"FlameGraph"),": \u53ef\u89c6\u5316\u5de5\u5177\uff0c\u7528\u4e8e\u5c06perf\u7684\u8f93\u51fa\u4ee5\u706b\u7130\u56fe\u7684\u5f62\u5f0f\u5c55\u793a\u51fa\u6765\u3002"),(0,r.kt)("h3",{id:"\u5185\u5b58"},"\u5185\u5b58"),(0,r.kt)("p",null,"\u5bf9\u4e8e\u5185\u5b58\u7684\u8c03\u8bd5\u4e00\u822c\u5206\u4e3a\u4e24\u4e2a\u65b9\u9762\u3002\u4e00\u4e2a\u662f\u5185\u5b58\u4f7f\u7528\u7684\u603b\u91cf\u662f\u5426\u5408\u7406\uff0c\u5185\u5b58\u4f7f\u7528\u91cf\u8fc7\u5927\u4e00\u65b9\u9762\u53ef\u80fd\u662f\u7531\u4e8e\u7cfb\u7edf\u5b58\u5728\u5185\u5b58\u6cc4\u9732\uff0c\u53e6\u4e00\u65b9\u9762\u53ef\u80fd\u662f\u56e0\u4e3a\u7a0b\u5e8f\u5185\u5b58\u4f7f\u7528\u4e0d\u5f53\u3002\u5176\u6b21\u5c31\u662f\u662f\u5426\u5b58\u5728\u5185\u5b58\u8d8a\u754c\u3001\u975e\u6cd5\u8bbf\u95ee\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u7a0b\u5e8f\u8bbf\u95ee\u4e00\u4e2a\u975e\u6cd5\u5730\u5740\u7684\u5185\u5b58\uff0c\u4f7f\u7528\u4e86\u672a\u521d\u59cb\u5316\u5185\u5b58\u7b49\u3002\u5bf9\u4e8e\u5185\u5b58\u65b9\u9762\u7684\u8c03\u8bd5\u6211\u4eec\u4e00\u822c\u4f7f\u7528\u5982\u4e0b\u51e0\u79cd\u65b9\u5f0f\u6765\u8fdb\u884c\u95ee\u9898\u8ffd\u8e2a\u3002"),(0,r.kt)("p",null,"Doris 1.2.1 \u53ca\u4e4b\u524d\u7248\u672c\u4f7f\u7528 TCMalloc\uff0cDoris 1.2.2 \u7248\u672c\u5f00\u59cb\u9ed8\u8ba4\u4f7f\u7528 Jemalloc\uff0c\u6839\u636e\u4f7f\u7528\u7684 Doris \u7248\u672c\u9009\u62e9\u5185\u5b58\u8c03\u8bd5\u65b9\u6cd5\uff0c\u5982\u9700\u5207\u6362 TCMalloc \u53ef\u4ee5\u8fd9\u6837\u7f16\u8bd1 ",(0,r.kt)("inlineCode",{parentName:"p"},"USE_JEMALLOC=OFF sh build.sh --be"),"\u3002"),(0,r.kt)("h4",{id:"\u67e5\u770b\u65e5\u5fd7"},"\u67e5\u770b\u65e5\u5fd7"),(0,r.kt)("p",null,"\u5f53\u53d1\u73b0\u5185\u5b58\u4f7f\u7528\u91cf\u8fc7\u5927\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u67e5\u770b BE \u65e5\u5fd7\uff0c\u770b\u770b\u662f\u5426\u6709\u5927\u5185\u5b58\u7533\u8bf7\u3002"),(0,r.kt)("h6",{id:"tcmalloc"},"TCMalloc"),(0,r.kt)("p",null,"\u5f53\u4f7f\u7528 TCMalloc \u65f6\uff0c\u9047\u5230\u5927\u5185\u5b58\u7533\u8bf7\u4f1a\u5c06\u7533\u8bf7\u7684\u5806\u6808\u6253\u5370\u5230be.out\u6587\u4ef6\u4e2d\uff0c\u4e00\u822c\u7684\u8868\u73b0\u5f62\u5f0f\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"tcmalloc: large alloc 1396277248 bytes == 0x3f3488000 @  0x2af6f63 0x2c4095b 0x134d278 0x134bdcb 0x133d105 0x133d1d0 0x19930ed\n")),(0,r.kt)("p",null,"\u8fd9\u4e2a\u8868\u793a\u5728Doris BE\u5728\u8fd9\u4e2a\u5806\u6808\u4e0a\u5c1d\u8bd5\u7533\u8bf7",(0,r.kt)("inlineCode",{parentName:"p"},"1396277248 bytes"),"\u7684\u5185\u5b58\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"addr2line"),"\u547d\u4ee4\u53bb\u628a\u5806\u6808\u8fd8\u539f\u6210\u6211\u4eec\u80fd\u591f\u770b\u61c2\u7684\u4fe1\uff0c\u5177\u4f53\u7684\u4f8b\u5b50\u5982\u4e0b\u6240\u793a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ addr2line -e lib/doris_be  0x2af6f63 0x2c4095b 0x134d278 0x134bdcb 0x133d105 0x133d1d0 0x19930ed\n\n/home/ssd0/zc/palo/doris/core/thirdparty/src/gperftools-gperftools-2.7/src/tcmalloc.cc:1335\n/home/ssd0/zc/palo/doris/core/thirdparty/src/gperftools-gperftools-2.7/src/tcmalloc.cc:1357\n/home/disk0/baidu-doris/baidu/bdg/doris-baidu/core/be/src/exec/hash_table.cpp:267\n/home/disk0/baidu-doris/baidu/bdg/doris-baidu/core/be/src/exec/hash_table.hpp:86\n/home/disk0/baidu-doris/baidu/bdg/doris-baidu/core/be/src/exec/hash_join_node.cpp:239\n/home/disk0/baidu-doris/baidu/bdg/doris-baidu/core/be/src/exec/hash_join_node.cpp:213\nthread.cpp:?\n")),(0,r.kt)("h5",{id:"jemalloc"},"JEMALLOC"),(0,r.kt)("p",null,"Doris\u7edd\u5927\u591a\u6570\u7684\u5927\u5185\u5b58\u7533\u8bf7\u90fd\u4f7f\u7528 Allocator\uff0c\u6bd4\u5982 HashTable\u3001\u6570\u636e\u5e8f\u5217\u5316\uff0c\u8fd9\u90e8\u5206\u5185\u5b58\u7533\u8bf7\u662f\u9884\u671f\u4e2d\u7684\uff0c\u4f1a\u88ab\u6709\u6548\u7ba1\u7406\u8d77\u6765\uff0c\u9664\u6b64\u4e4b\u5916\u7684\u5927\u5185\u5b58\u7533\u8bf7\u4e0d\u88ab\u9884\u671f\uff0c\u4f1a\u5c06\u7533\u8bf7\u7684\u5806\u6808\u6253\u5370\u5230 be.INFO \u6587\u4ef6\u4e2d\uff0c\u8fd9\u901a\u5e38\u7528\u4e8e\u8c03\u8bd5\uff0c\u4e00\u822c\u7684\u8868\u73b0\u5f62\u5f0f\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"MemHook alloc large memory: 8.2GB, stacktrace:\nAlloc Stacktrace:\n    @     0x55a6a5cf6b4d  doris::ThreadMemTrackerMgr::consume()\n    @     0x55a6a5cf99bf  malloc\n    @     0x55a6ae0caf98  operator new()\n    @     0x55a6a57cb013  doris::segment_v2::PageIO::read_and_decompress_page()\n    @     0x55a6a57719c0  doris::segment_v2::ColumnReader::read_page()\n    \u2026\u2026\n")),(0,r.kt)("h4",{id:"heap-profile"},"HEAP PROFILE"),(0,r.kt)("h5",{id:"tcmalloc-1"},"TCMalloc"),(0,r.kt)("p",null,"\u6709\u65f6\u5185\u5b58\u7684\u7533\u8bf7\u5e76\u4e0d\u662f\u5927\u5185\u5b58\u7684\u7533\u8bf7\u5bfc\u81f4\uff0c\u800c\u662f\u901a\u8fc7\u5c0f\u5185\u5b58\u4e0d\u65ad\u7684\u5806\u79ef\u5bfc\u81f4\u7684\u3002\u90a3\u4e48\u5c31\u6ca1\u6709\u529e\u6cd5\u901a\u8fc7\u67e5\u770b\u65e5\u5fd7\u5b9a\u4f4d\u5230\u5177\u4f53\u7684\u7533\u8bf7\u4fe1\u606f\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u901a\u8fc7\u5176\u4ed6\u65b9\u5f0f\u6765\u83b7\u5f97\u4fe1\u606f\u3002"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5229\u7528TCMalloc\u7684",(0,r.kt)("a",{parentName:"p",href:"https://gperftools.github.io/gperftools/heapprofile.html"},"HEAP PROFILE"),"\u7684\u529f\u80fd\u3002\u5982\u679c\u8bbe\u7f6e\u4e86HEAPPROFILE\u529f\u80fd\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u83b7\u5f97\u8fdb\u7a0b\u6574\u4f53\u7684\u5185\u5b58\u7533\u8bf7\u4f7f\u7528\u60c5\u51b5\u3002\u4f7f\u7528\u65b9\u5f0f\u662f\u5728\u542f\u52a8Doris BE\u524d\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"HEAPPROFILE"),"\u73af\u5883\u53d8\u91cf\u3002\u6bd4\u5982\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"export HEAPPROFILE=/tmp/doris_be.hprof\n./bin/start_be.sh --daemon\n")),(0,r.kt)("p",null,"\u8fd9\u6837\uff0c\u5f53\u6ee1\u8db3HEAPPROFILE\u7684dump\u6761\u4ef6\u65f6\uff0c\u5c31\u4f1a\u5c06\u5185\u5b58\u7684\u6574\u4f53\u4f7f\u7528\u60c5\u51b5\u5199\u5230\u6307\u5b9a\u8def\u5f84\u7684\u6587\u4ef6\u4e2d\u3002\u540e\u7eed\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"pprof"),"\u5de5\u5177\u6765\u5bf9\u8f93\u51fa\u7684\u5185\u5bb9\u8fdb\u884c\u5206\u6790\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pprof --text lib/doris_be /tmp/doris_be.hprof.0012.heap | head -30\n\nUsing local file lib/doris_be.\nUsing local file /tmp/doris_be.hprof.0012.heap.\nTotal: 668.6 MB\n   610.6  91.3%  91.3%    610.6  91.3% doris::SystemAllocator::allocate_via_malloc (inline)\n    18.1   2.7%  94.0%     18.1   2.7% _objalloc_alloc\n     5.6   0.8%  94.9%     63.4   9.5% doris::RowBatch::RowBatch\n     5.1   0.8%  95.6%      7.1   1.1% butil::ResourcePool::add_block (inline)\n     3.7   0.5%  96.2%      3.7   0.5% butil::iobuf::create_block (inline)\n     3.4   0.5%  96.7%      3.4   0.5% butil::FlatMap::init\n     3.2   0.5%  97.2%      5.2   0.8% butil::ObjectPool::add_block (inline)\n     2.6   0.4%  97.6%      2.6   0.4% __gnu_cxx::new_allocator::allocate (inline)\n     2.0   0.3%  97.9%      2.0   0.3% butil::ObjectPool::add_block_group (inline)\n     2.0   0.3%  98.2%      2.0   0.3% butil::ResourcePool::add_block_group (inline)\n     1.7   0.3%  98.4%      1.7   0.3% doris::SegmentReader::_load_index\n")),(0,r.kt)("p",null,"\u4e0a\u8ff0\u6587\u4ef6\u5404\u4e2a\u5217\u7684\u5185\u5bb9\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u7b2c\u4e00\u5217\uff1a\u51fd\u6570\u76f4\u63a5\u7533\u8bf7\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u5355\u4f4dMB"),(0,r.kt)("li",{parentName:"ul"},"\u7b2c\u56db\u5217\uff1a\u51fd\u6570\u4ee5\u53ca\u51fd\u6570\u6240\u6709\u8c03\u7528\u7684\u51fd\u6570\u603b\u5171\u5185\u5b58\u5927\u5c0f\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u7b2c\u4e8c\u5217\u3001\u7b2c\u4e94\u5217\u5206\u522b\u662f\u7b2c\u4e00\u5217\u4e0e\u7b2c\u56db\u5217\u7684\u6bd4\u4f8b\u503c\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u7b2c\u4e09\u5217\u662f\u4e2a\u7b2c\u4e8c\u5217\u7684\u7d2f\u79ef\u503c\u3002")),(0,r.kt)("p",null,"\u5f53\u7136\u4e5f\u53ef\u4ee5\u751f\u6210\u8c03\u7528\u5173\u7cfb\u56fe\u7247\uff0c\u66f4\u52a0\u65b9\u4fbf\u5206\u6790\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u547d\u4ee4\u5c31\u80fd\u591f\u751f\u6210SVG\u683c\u5f0f\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pprof --svg lib/doris_be /tmp/doris_be.hprof.0012.heap > heap.svg \n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a\u5f00\u542f\u8fd9\u4e2a\u9009\u9879\u662f\u8981\u5f71\u54cd\u7a0b\u5e8f\u7684\u6267\u884c\u6027\u80fd\u7684\uff0c\u8bf7\u614e\u91cd\u5bf9\u7ebf\u4e0a\u7684\u5b9e\u4f8b\u5f00\u542f")),(0,r.kt)("h6",{id:"pprof-remote-server"},"pprof remote server"),(0,r.kt)("p",null,"HEAP PROFILE\u867d\u7136\u80fd\u591f\u83b7\u5f97\u5168\u90e8\u7684\u5185\u5b58\u4f7f\u7528\u4fe1\u606f\uff0c\u4f46\u662f\u4e5f\u6709\u6bd4\u8f83\u53d7\u9650\u7684\u5730\u65b9\u30021. \u9700\u8981\u91cd\u542fBE\u8fdb\u884c\u30022. \u9700\u8981\u4e00\u76f4\u5f00\u542f\u8fd9\u4e2a\u547d\u4ee4\uff0c\u5bfc\u81f4\u5bf9\u6574\u4e2a\u8fdb\u7a0b\u7684\u6027\u80fd\u9020\u6210\u5f71\u54cd\u3002"),(0,r.kt)("p",null,"\u5bf9Doris BE\u4e5f\u53ef\u4ee5\u4f7f\u7528\u52a8\u6001\u5f00\u542f\u3001\u5173\u95edheap profile\u7684\u65b9\u5f0f\u6765\u5bf9\u8fdb\u7a0b\u8fdb\u884c\u5185\u5b58\u7533\u8bf7\u5206\u6790\u3002Doris\u5185\u90e8\u652f\u6301\u4e86GPerftools\u7684",(0,r.kt)("a",{parentName:"p",href:"https://gperftools.github.io/gperftools/pprof_remote_servers.html"},"\u8fdc\u7a0bserver\u8c03\u8bd5"),"\u3002\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"pprof"),"\u76f4\u63a5\u5bf9\u8fdc\u7a0b\u8fd0\u884c\u7684Doris BE\u8fdb\u884c\u52a8\u6001\u7684HEAP PROFILE\u3002\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u67e5\u770bDoris\u7684\u5185\u5b58\u7684\u4f7f\u7528\u589e\u91cf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pprof --text --seconds=60 http://be_host:be_webport/pprof/heap \n\nTotal: 1296.4 MB\n   484.9  37.4%  37.4%    484.9  37.4% doris::StorageByteBuffer::create\n   272.2  21.0%  58.4%    273.3  21.1% doris::RowBlock::init\n   157.5  12.1%  70.5%    157.5  12.1% doris::RowBatch::RowBatch\n    90.7   7.0%  77.5%     90.7   7.0% doris::SystemAllocator::allocate_via_malloc\n    66.6   5.1%  82.7%     66.6   5.1% doris::IntegerColumnReader::init\n    47.9   3.7%  86.4%     47.9   3.7% __gnu_cxx::new_allocator::allocate\n    20.8   1.6%  88.0%     35.4   2.7% doris::SegmentReader::_load_index\n    12.7   1.0%  89.0%     12.7   1.0% doris::DecimalColumnReader::init\n    12.7   1.0%  89.9%     12.7   1.0% doris::LargeIntColumnReader::init\n    12.7   1.0%  90.9%     12.7   1.0% doris::StringColumnDirectReader::init\n    12.3   0.9%  91.9%     12.3   0.9% std::__cxx11::basic_string::_M_mutate\n    10.4   0.8%  92.7%     10.4   0.8% doris::VectorizedRowBatch::VectorizedRowBatch\n    10.0   0.8%  93.4%     10.0   0.8% doris::PlainTextLineReader::PlainTextLineReader\n")),(0,r.kt)("p",null,"\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e0eHEAP PROFILE\u7684\u8f93\u51fa\u53ca\u67e5\u770b\u65b9\u5f0f\u4e00\u6837\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8be6\u7ec6\u8bf4\u660e\u3002\u8fd9\u4e2a\u547d\u4ee4\u53ea\u6709\u5728\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\u624d\u4f1a\u5f00\u542f\u7edf\u8ba1\uff0c\u76f8\u6bd4HEAP PROFILE\u5bf9\u4e8e\u8fdb\u7a0b\u6027\u80fd\u7684\u5f71\u54cd\u6709\u9650\u3002"),(0,r.kt)("h5",{id:"jemalloc-1"},"JEMALLOC"),(0,r.kt)("h6",{id:"1-runtime-heap-dump-by-http"},"1. runtime heap dump by http"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"start_be.sh")," \u4e2d",(0,r.kt)("inlineCode",{parentName:"p"},"JEMALLOC_CONF")," \u589e\u52a0 ",(0,r.kt)("inlineCode",{parentName:"p"},",prof:true,lg_prof_sample:10")," \u5e76\u91cd\u542fBE\uff0c\u7136\u540e\u4f7f\u7528jemalloc heap dump http\u63a5\u53e3\uff0c\u5728\u5bf9\u5e94\u7684BE\u673a\u5668\u4e0a\u751f\u6210heap dump\u6587\u4ef6\u3002"),(0,r.kt)("p",null,"heap dump\u6587\u4ef6\u6240\u5728\u76ee\u5f55\u53ef\u4ee5\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"be.conf")," \u4e2d\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"jeprofile_dir"),"\u53d8\u91cf\u8fdb\u884c\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"${DORIS_HOME}/log")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl http://be_host:be_webport/jeheap/dump\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"prof"),": \u6253\u5f00\u540ejemalloc\u5c06\u6839\u636e\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u751f\u6210heap dump\u6587\u4ef6\uff0cheap profile\u91c7\u6837\u5b58\u5728\u5c11\u91cf\u6027\u80fd\u635f\u8017\uff0c\u6027\u80fd\u6d4b\u8bd5\u65f6\u53ef\u5173\u95ed\u3002\n",(0,r.kt)("inlineCode",{parentName:"p"},"lg_prof_sample"),": heap profile\u91c7\u6837\u95f4\u9694\uff0c\u9ed8\u8ba4\u503c19\uff0c\u5373\u9ed8\u8ba4\u91c7\u6837\u95f4\u9694\u4e3a512K(2^19 B)\uff0c\u8fd9\u4f1a\u5bfc\u81f4heap profile\u8bb0\u5f55\u7684\u5185\u5b58\u901a\u5e38\u53ea\u670910%\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"lg_prof_sample:10"),"\u53ef\u4ee5\u51cf\u5c11\u91c7\u6837\u95f4\u9694\u52301K (2^10 B), \u66f4\u9891\u7e41\u7684\u91c7\u6837\u4f1a\u4f7fheap profile\u63a5\u8fd1\u771f\u5b9e\u5185\u5b58\uff0c\u4f46\u8fd9\u4f1a\u5e26\u6765\u66f4\u5927\u7684\u6027\u80fd\u635f\u8017\u3002"),(0,r.kt)("p",null,"\u8be6\u7ec6\u53c2\u6570\u8bf4\u660e\u53c2\u8003 ",(0,r.kt)("a",{parentName:"p",href:"https://linux.die.net/man/3/jemalloc%E3%80%82"},"https://linux.die.net/man/3/jemalloc\u3002")),(0,r.kt)("h5",{id:"2-jemalloc-heap-dump-profiling"},"2. jemalloc heap dump profiling"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5355\u4e2aheap dump\u6587\u4ef6\u751f\u6210\u7eaf\u6587\u672c\u5206\u6790\u7ed3\u679c")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   jeprof lib/doris_be heap_dump_file_1\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u5206\u6790\u4e24\u4e2aheap dump\u7684diff"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"jeprof lib/doris_be --base=heap_dump_file_1 heap_dump_file_2\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u751f\u6210\u8c03\u7528\u5173\u7cfb\u56fe\u7247"),(0,r.kt)("p",{parentName:"li"},"\u5b89\u88c5\u7ed8\u56fe\u6240\u9700\u7684\u4f9d\u8d56\u9879"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install ghostscript graphviz\n")),(0,r.kt)("p",{parentName:"li"},"\u901a\u8fc7\u5728\u4e00\u77ed\u65f6\u95f4\u5185\u591a\u6b21\u8fd0\u884c\u4e0a\u8ff0\u547d\u4ee4\u53ef\u4ee5\u751f\u6210\u591a\u4efddump \u6587\u4ef6\uff0c\u53ef\u4ee5\u9009\u53d6\u7b2c\u4e00\u4efddump \u6587\u4ef6\u4f5c\u4e3abaseline \u8fdb\u884cdiff\u5bf9\u6bd4\u5206\u6790"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"jeprof --dot lib/doris_be --base=heap_dump_file_1 heap_dump_file_2\n")),(0,r.kt)("p",{parentName:"li"},"\u6267\u884c\u5b8c\u4e0a\u8ff0\u547d\u4ee4\uff0c\u7ec8\u7aef\u4e2d\u4f1a\u8f93\u51fadot\u8bed\u6cd5\u7684\u56fe\uff0c\u5c06\u5176\u8d34\u5230",(0,r.kt)("a",{parentName:"p",href:"http://www.webgraphviz.com/"},"\u5728\u7ebfdot\u7ed8\u56fe\u7f51\u7ad9"),"\uff0c\u751f\u6210\u5185\u5b58\u5206\u914d\u56fe\uff0c\u7136\u540e\u8fdb\u884c\u5206\u6790\uff0c\u6b64\u79cd\u65b9\u5f0f\u80fd\u591f\u76f4\u63a5\u901a\u8fc7\u7ec8\u7aef\u8f93\u51fa\u7ed3\u679c\u8fdb\u884c\u7ed8\u56fe\uff0c\u6bd4\u8f83\u9002\u7528\u4e8e\u4f20\u8f93\u6587\u4ef6\u4e0d\u662f\u5f88\u65b9\u4fbf\u7684\u670d\u52a1\u5668\u3002"),(0,r.kt)("p",{parentName:"li"},"\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u76f4\u63a5\u751f\u6210\u8c03\u7528\u5173\u7cfbresult.pdf\u6587\u4ef6\u4f20\u8f93\u5230\u672c\u5730\u540e\u8fdb\u884c\u67e5\u770b"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"jeprof --pdf lib/doris_be --base=heap_dump_file_1 heap_dump_file_2 > result.pdf\n")))),(0,r.kt)("h6",{id:"3-heap-dump-by-jemalloc_conf"},"3. heap dump by JEMALLOC_CONF"),(0,r.kt)("p",null,"\u4e5f\u53ef\u901a\u8fc7\u66f4\u6539",(0,r.kt)("inlineCode",{parentName:"p"},"start_be.sh")," \u4e2d",(0,r.kt)("inlineCode",{parentName:"p"},"JEMALLOC_CONF")," \u53d8\u91cf\u540e\u91cd\u65b0\u542f\u52a8 BE \u6765\u8fdb\u884c\u5b9a\u671f heap dump"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6bcf1MB dump\u4e00\u6b21:"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"JEMALLOC_CONF"),"\u53d8\u91cf\u4e2d\u65b0\u589e\u4e24\u4e2a\u53d8\u91cf\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"prof:true,lg_prof_interval:20"),"  \u5176\u4e2d",(0,r.kt)("inlineCode",{parentName:"p"},"prof:true"),"\u662f\u6253\u5f00profiling\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"lg_prof_interval:20"),"\u4e2d\u8868\u793a\u6bcf1MB(2^20)\u751f\u6210\u4e00\u6b21dump ")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6bcf\u6b21\u8fbe\u5230\u65b0\u9ad8\u65f6dump:"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"JEMALLOC_CONF"),"\u53d8\u91cf\u4e2d\u65b0\u589e\u4e24\u4e2a\u53d8\u91cf\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"prof:true,prof_gdump:true")," \u5176\u4e2d",(0,r.kt)("inlineCode",{parentName:"p"},"prof:true"),"\u662f\u6253\u5f00profiling\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"prof_gdump:true")," \u4ee3\u8868\u5185\u5b58\u4f7f\u7528\u8fbe\u5230\u65b0\u9ad8\u65f6\u751f\u6210dump")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u7a0b\u5e8f\u9000\u51fa\u65f6\u5185\u5b58\u6cc4\u6f0fdump:"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"JEMALLOC_CONF"),"\u53d8\u91cf\u4e2d\u65b0\u589e\u4e09\u4e2a\u53d8\u91cf\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"prof_leak:true,lg_prof_sample:0,prof_final:true")))),(0,r.kt)("h4",{id:"lsan"},"LSAN"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer"},"LSAN"),"\u662f\u4e00\u4e2a\u5730\u5740\u68c0\u67e5\u5de5\u5177\uff0cGCC\u5df2\u7ecf\u96c6\u6210\u3002\u5728\u6211\u4eec\u7f16\u8bd1\u4ee3\u7801\u7684\u65f6\u5019\u5f00\u542f\u76f8\u5e94\u7684\u7f16\u8bd1\u9009\u9879\uff0c\u5c31\u80fd\u591f\u5f00\u542f\u8fd9\u4e2a\u529f\u80fd\u3002\u5f53\u7a0b\u5e8f\u53d1\u751f\u53ef\u4ee5\u786e\u5b9a\u7684\u5185\u5b58\u6cc4\u9732\u65f6\uff0c\u4f1a\u5c06\u6cc4\u9732\u5806\u6808\u6253\u5370\u3002Doris BE\u5df2\u7ecf\u96c6\u6210\u4e86\u8fd9\u4e2a\u5de5\u5177\uff0c\u53ea\u9700\u8981\u5728\u7f16\u8bd1\u7684\u65f6\u5019\u4f7f\u7528\u5982\u4e0b\u7684\u547d\u4ee4\u8fdb\u884c\u7f16\u8bd1\u5c31\u80fd\u591f\u751f\u6210\u5e26\u6709\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u7248\u672c\u7684BE\u4e8c\u8fdb\u5236"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BUILD_TYPE=LSAN ./build.sh\n")),(0,r.kt)("p",null,"\u5f53\u7cfb\u7edf\u68c0\u6d4b\u5230\u5185\u5b58\u6cc4\u9732\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u5728be.out\u91cc\u9762\u8f93\u51fa\u5bf9\u5e94\u7684\u4fe1\u606f\u3002\u4e3a\u4e86\u4e0b\u9762\u7684\u6f14\u793a\uff0c\u6211\u4eec\u6545\u610f\u5728\u4ee3\u7801\u4e2d\u63d2\u5165\u4e00\u6bb5\u5185\u5b58\u6cc4\u9732\u4ee3\u7801\u3002\u6211\u4eec\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"StorageEngine"),"\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"open"),"\u51fd\u6570\u4e2d\u63d2\u5165\u5982\u4e0b\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    char* leak_buf = new char[1024];\n    strcpy(leak_buf, "hello world");\n    LOG(INFO) << leak_buf;\n')),(0,r.kt)("p",null,"\u6211\u4eec\u5c31\u5728be.out\u4e2d\u83b7\u5f97\u4e86\u5982\u4e0b\u7684\u8f93\u51fa"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"=================================================================\n==24732==ERROR: LeakSanitizer: detected memory leaks\n\nDirect leak of 1024 byte(s) in 1 object(s) allocated from:\n    #0 0xd10586 in operator new[](unsigned long) ../../../../gcc-7.3.0/libsanitizer/lsan/lsan_interceptors.cc:164\n    #1 0xe333a2 in doris::StorageEngine::open(doris::EngineOptions const&, doris::StorageEngine**) /home/ssd0/zc/palo/doris/core/be/src/olap/storage_engine.cpp:104\n    #2 0xd3cc96 in main /home/ssd0/zc/palo/doris/core/be/src/service/doris_main.cpp:159\n    #3 0x7f573b5eebd4 in __libc_start_main (/opt/compiler/gcc-4.8.2/lib64/libc.so.6+0x21bd4)\n\nSUMMARY: LeakSanitizer: 1024 byte(s) leaked in 1 allocation(s).\n")),(0,r.kt)("p",null,"\u4ece\u4e0a\u8ff0\u7684\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u80fd\u770b\u5230\u67091024\u4e2a\u5b57\u8282\u88ab\u6cc4\u9732\u4e86\uff0c\u5e76\u4e14\u6253\u5370\u51fa\u6765\u4e86\u5185\u5b58\u7533\u8bf7\u65f6\u7684\u5806\u6808\u4fe1\u606f\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a\u5f00\u542f\u8fd9\u4e2a\u9009\u9879\u662f\u8981\u5f71\u54cd\u7a0b\u5e8f\u7684\u6267\u884c\u6027\u80fd\u7684\uff0c\u8bf7\u614e\u91cd\u5bf9\u7ebf\u4e0a\u7684\u5b9e\u4f8b\u5f00\u542f")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a\u5982\u679c\u5f00\u542f\u4e86LSAN\u5f00\u5173\u7684\u8bdd\uff0ctcmalloc\u5c31\u4f1a\u88ab\u81ea\u52a8\u5173\u95ed")),(0,r.kt)("h4",{id:"asan"},"ASAN"),(0,r.kt)("p",null,"\u9664\u4e86\u5185\u5b58\u4f7f\u7528\u4e0d\u5408\u7406\u3001\u6cc4\u9732\u4ee5\u5916\u3002\u6709\u7684\u65f6\u5019\u4e5f\u4f1a\u53d1\u751f\u5185\u5b58\u8bbf\u95ee\u975e\u6cd5\u5730\u5740\u7b49\u9519\u8bef\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u501f\u52a9",(0,r.kt)("a",{parentName:"p",href:"https://github.com/google/sanitizers/wiki/AddressSanitizer"},"ASAN"),"\u6765\u8f85\u52a9\u6211\u4eec\u627e\u5230\u95ee\u9898\u7684\u539f\u56e0\u3002\u4e0eLSAN\u4e00\u6837\uff0cASAN\u4e5f\u96c6\u6210\u5728\u4e86GCC\u4e2d\u3002Doris\u901a\u8fc7\u5982\u4e0b\u7684\u65b9\u5f0f\u8fdb\u884c\u7f16\u8bd1\u5c31\u80fd\u591f\u5f00\u542f\u8fd9\u4e2a\u529f\u80fd"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BUILD_TYPE=ASAN ./build.sh\n")),(0,r.kt)("p",null,"\u6267\u884c\u7f16\u8bd1\u751f\u6210\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5f53\u68c0\u6d4b\u5de5\u5177\u53d1\u73b0\u6709\u5f02\u5e38\u8bbf\u95ee\u65f6\uff0c\u5c31\u4f1a\u7acb\u5373\u9000\u51fa\uff0c\u5e76\u5c06\u975e\u6cd5\u8bbf\u95ee\u7684\u5806\u6808\u8f93\u51fa\u5728be.out\u4e2d\u3002\u5bf9\u4e8eASAN\u7684\u8f93\u51fa\u4e0eLSAN\u662f\u4e00\u6837\u7684\u5206\u6790\u65b9\u6cd5\u3002\u8fd9\u91cc\u6211\u4eec\u4e5f\u4e3b\u52a8\u6ce8\u5165\u4e00\u4e2a\u5730\u5740\u8bbf\u95ee\u9519\u8bef\uff0c\u6765\u5c55\u793a\u4e0b\u5177\u4f53\u7684\u5185\u5bb9\u8f93\u51fa\u3002\u6211\u4eec\u4ecd\u7136\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"StorageEngine"),"\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"open"),"\u51fd\u6570\u4e2d\u6ce8\u5165\u4e00\u6bb5\u975e\u6cd5\u5185\u5b58\u8bbf\u95ee\uff0c\u5177\u4f53\u7684\u9519\u8bef\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    char* invalid_buf = new char[1024];\n    for (int i = 0; i < 1025; ++i) {\n        invalid_buf[i] = i;\n    }\n    LOG(INFO) << invalid_buf;\n")),(0,r.kt)("p",null,"\u7136\u540e\u6211\u4eec\u5c31\u4f1a\u5728be.out\u4e2d\u83b7\u5f97\u5982\u4e0b\u7684\u8f93\u51fa"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"=================================================================\n==23284==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x61900008bf80 at pc 0x00000129f56a bp 0x7fff546eed90 sp 0x7fff546eed88\nWRITE of size 1 at 0x61900008bf80 thread T0\n    #0 0x129f569 in doris::StorageEngine::open(doris::EngineOptions const&, doris::StorageEngine**) /home/ssd0/zc/palo/doris/core/be/src/olap/storage_engine.cpp:106\n    #1 0xe2c1e3 in main /home/ssd0/zc/palo/doris/core/be/src/service/doris_main.cpp:159\n    #2 0x7fa5580fbbd4 in __libc_start_main (/opt/compiler/gcc-4.8.2/lib64/libc.so.6+0x21bd4)\n    #3 0xd30794  (/home/ssd0/zc/palo/doris/core/output3/be/lib/doris_be+0xd30794)\n\n0x61900008bf80 is located 0 bytes to the right of 1024-byte region [0x61900008bb80,0x61900008bf80)\nallocated by thread T0 here:\n    #0 0xdeb040 in operator new[](unsigned long) ../../../../gcc-7.3.0/libsanitizer/asan/asan_new_delete.cc:82\n    #1 0x129f50d in doris::StorageEngine::open(doris::EngineOptions const&, doris::StorageEngine**) /home/ssd0/zc/palo/doris/core/be/src/olap/storage_engine.cpp:104\n    #2 0xe2c1e3 in main /home/ssd0/zc/palo/doris/core/be/src/service/doris_main.cpp:159\n    #3 0x7fa5580fbbd4 in __libc_start_main (/opt/compiler/gcc-4.8.2/lib64/libc.so.6+0x21bd4)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow /home/ssd0/zc/palo/doris/core/be/src/olap/storage_engine.cpp:106 in doris::StorageEngine::open(doris::EngineOptions const&, doris::StorageEngine**)\n")),(0,r.kt)("p",null,"\u4ece\u8fd9\u6bb5\u4fe1\u606f\u4e2d\u8be5\u53ef\u4ee5\u770b\u5230\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"0x61900008bf80"),"\u8fd9\u4e2a\u5730\u5740\u6211\u4eec\u5c1d\u8bd5\u53bb\u5199\u4e00\u4e2a\u5b57\u8282\uff0c\u4f46\u662f\u8fd9\u4e2a\u5730\u5740\u662f\u975e\u6cd5\u7684\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"[0x61900008bb80,0x61900008bf80)"),"\u8fd9\u4e2a\u5730\u5740\u7684\u7533\u8bf7\u5806\u6808\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a\u5f00\u542f\u8fd9\u4e2a\u9009\u9879\u662f\u8981\u5f71\u54cd\u7a0b\u5e8f\u7684\u6267\u884c\u6027\u80fd\u7684\uff0c\u8bf7\u614e\u91cd\u5bf9\u7ebf\u4e0a\u7684\u5b9e\u4f8b\u5f00\u542f")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a\u5982\u679c\u5f00\u542f\u4e86ASAN\u5f00\u5173\u7684\u8bdd\uff0ctcmalloc\u5c31\u4f1a\u88ab\u81ea\u52a8\u5173\u95ed")),(0,r.kt)("p",null,"\u53e6\u5916\uff0c\u5982\u679cbe.out\u4e2d\u8f93\u51fa\u4e86\u5806\u6808\u4fe1\u606f\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u51fd\u6570\u7b26\u53f7\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u6211\u4eec\u624b\u52a8\u7684\u5904\u7406\u4e0b\u624d\u80fd\u83b7\u5f97\u53ef\u8bfb\u7684\u5806\u6808\u4fe1\u606f\u3002\u5177\u4f53\u7684\u5904\u7406\u65b9\u6cd5\u9700\u8981\u501f\u52a9\u4e00\u4e2a\u811a\u672c\u6765\u89e3\u6790ASAN\u7684\u8f93\u51fa\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u9700\u8981\u4f7f\u7528",(0,r.kt)("a",{parentName:"p",href:"https://llvm.org/svn/llvm-project/compiler-rt/trunk/lib/asan/scripts/asan_symbolize.py"},"asan_symbolize"),"\u6765\u5e2e\u5fd9\u89e3\u6790\u4e0b\u3002\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cat be.out | python asan_symbolize.py | c++filt\n")),(0,r.kt)("p",null,"\u901a\u8fc7\u4e0a\u8ff0\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u83b7\u5f97\u53ef\u8bfb\u7684\u5806\u6808\u4fe1\u606f\u4e86\u3002"),(0,r.kt)("h3",{id:"cpu"},"CPU"),(0,r.kt)("p",null,"\u5f53\u7cfb\u7edf\u7684CPU Idle\u5f88\u4f4e\u7684\u65f6\u5019\uff0c\u8bf4\u660e\u7cfb\u7edf\u7684CPU\u5df2\u7ecf\u6210\u4e3a\u4e86\u4e3b\u8981\u74f6\u9888\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u5206\u6790\u4e00\u4e0b\u5f53\u524d\u7684CPU\u4f7f\u7528\u60c5\u51b5\u3002\u5bf9\u4e8eDoris\u7684BE\u53ef\u4ee5\u6709\u5982\u4e0b\u4e24\u79cd\u65b9\u5f0f\u6765\u5206\u6790Doris\u7684CPU\u74f6\u9888\u3002"),(0,r.kt)("h4",{id:"pprof"},"pprof"),(0,r.kt)("p",null,"\u7531\u4e8eDoris\u5185\u90e8\u5df2\u7ecf\u96c6\u6210\u4e86\u5e76\u517c\u5bb9\u4e86GPerf\u7684REST\u63a5\u53e3\uff0c\u90a3\u4e48\u7528\u6237\u53ef\u4ee5\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"pprof"),"\u5de5\u5177\u6765\u5206\u6790\u8fdc\u7a0b\u7684Doris BE\u3002\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pprof --svg --seconds=60 http://be_host:be_webport/pprof/profile > be.svg \n")),(0,r.kt)("p",null,"\u8fd9\u6837\u5c31\u80fd\u591f\u751f\u6210\u4e00\u5f20BE\u6267\u884c\u7684CPU\u6d88\u8017\u56fe\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"CPU Pprof",src:a(72949).Z,width:"1196",height:"1488"})),(0,r.kt)("h4",{id:"perf--flamegragh"},"perf + flamegragh"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u662f\u76f8\u5f53\u901a\u7528\u7684\u4e00\u79cdCPU\u5206\u6790\u65b9\u5f0f\uff0c\u76f8\u6bd4\u4e8e",(0,r.kt)("inlineCode",{parentName:"p"},"pprof"),"\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5fc5\u987b\u8981\u6c42\u80fd\u591f\u767b\u9646\u5230\u5206\u6790\u5bf9\u8c61\u7684\u7269\u7406\u673a\u4e0a\u3002\u4f46\u662f\u76f8\u6bd4\u4e8epprof\u53ea\u80fd\u5b9a\u65f6\u91c7\u70b9\uff0cperf\u662f\u80fd\u591f\u901a\u8fc7\u4e0d\u540c\u7684\u4e8b\u4ef6\u6765\u5b8c\u6210\u5806\u6808\u4fe1\u606f\u91c7\u96c6\u7684\u3002\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"perf record -g -p be_pid -- sleep 60\n")),(0,r.kt)("p",null,"\u8fd9\u6761\u547d\u4ee4\u4f1a\u7edf\u8ba160\u79d2\u949fBE\u7684CPU\u8fd0\u884c\u60c5\u51b5\uff0c\u5e76\u4e14\u751f\u6210perf.data\u3002\u5bf9\u4e8eperf.data\u7684\u5206\u6790\uff0c\u53ef\u4ee5\u901a\u8fc7perf\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u5206\u6790"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"perf report\n")),(0,r.kt)("p",null,"\u5206\u6790\u5f97\u5230\u5982\u4e0b\u7684\u56fe\u7247"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Perf Report",src:a(54480).Z,width:"1102",height:"412"})),(0,r.kt)("p",null,"\u6765\u5bf9\u751f\u6210\u7684\u5185\u5bb9\u8fdb\u884c\u5206\u6790\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528flamegragh\u5b8c\u6210\u53ef\u89c6\u5316\u5c55\u793a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"perf script | ./FlameGraph/stackcollapse-perf.pl | ./FlameGraph/flamegraph.pl > be.svg\n")),(0,r.kt)("p",null,"\u8fd9\u6837\u4e5f\u4f1a\u751f\u6210\u4e00\u5f20\u5f53\u65f6\u8fd0\u884c\u7684CPU\u6d88\u8017\u56fe\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"CPU Flame",src:a(27721).Z,width:"1200",height:"418"})))}m.isMDXComponent=!0},27721:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/cpu-flame-demo-727a5b8c32db9b3b129481ac75405b5d.svg"},72949:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/cpu-pprof-demo-46064afc3672559af190f0698ed9ef52.png"},54480:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/perf-report-demo-5987234ce899968a08be49a29f51acb1.png"}}]);