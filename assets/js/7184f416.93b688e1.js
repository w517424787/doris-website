"use strict";(self.webpackChunkselectdb_portal=self.webpackChunkselectdb_portal||[]).push([[90433],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=a.createContext({}),s=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(d.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,d=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=s(n),k=r,c=u["".concat(d,".").concat(k)]||u[k]||m[k]||l;return n?a.createElement(c,i(i({ref:t},p),{},{components:n})):a.createElement(c,i({ref:t},p))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=k;var o={};for(var d in t)hasOwnProperty.call(t,d)&&(o[d]=t[d]);o.originalType=e,o[u]="string"==typeof e?e:r,i[1]=o;for(var s=2;s<l;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},24725:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=n(87462),r=(n(67294),n(3905));const l={title:"Doris On ES",language:"en"},i=void 0,o={unversionedId:"extending-doris/doris-on-es",id:"version-0.15/extending-doris/doris-on-es",title:"Doris On ES",description:"\x3c!--",source:"@site/versioned_docs/version-0.15/extending-doris/doris-on-es.md",sourceDirName:"extending-doris",slug:"/extending-doris/doris-on-es",permalink:"/docs/0.15/extending-doris/doris-on-es",draft:!1,tags:[],version:"0.15",frontMatter:{title:"Doris On ES",language:"en"},sidebar:"docs",previous:{title:"Audit log plugin",permalink:"/docs/0.15/extending-doris/audit-plugin"},next:{title:"Logstash Doris Output Plugin",permalink:"/docs/0.15/extending-doris/logstash"}},d={},s=[{value:"Glossary",id:"glossary",level:2},{value:"Noun in Doris",id:"noun-in-doris",level:3},{value:"Noun in ES",id:"noun-in-es",level:3},{value:"How To Use",id:"how-to-use",level:2},{value:"Create ES Index",id:"create-es-index",level:3},{value:"Add JSON documents to ES index",id:"add-json-documents-to-es-index",level:3},{value:"Create external ES table",id:"create-external-es-table",level:3},{value:"Filter to push down",id:"filter-to-push-down",level:5},{value:"Data type mapping",id:"data-type-mapping",level:5},{value:"Enable column scan to optimize query speed(enable_docvalue_scan=true)",id:"enable-column-scan-to-optimize-query-speedenable_docvalue_scantrue",level:3},{value:"Advantage:",id:"advantage",level:5},{value:"Tip",id:"tip",level:5},{value:"Detect keyword type field(enable_keyword_sniff=true)",id:"detect-keyword-type-fieldenable_keyword_snifftrue",level:3},{value:"Enable node discovery mechanism, default is true(es_nodes_discovery=true)",id:"enable-node-discovery-mechanism-default-is-truees_nodes_discoverytrue",level:3},{value:"Whether ES cluster enables https access mode, if enabled should set value with<code>true</code>, default is false(http_ssl_enable=true)",id:"whether-es-cluster-enables-https-access-mode-if-enabled-should-set-value-withtrue-default-is-falsehttp_ssl_enabletrue",level:3},{value:"Query usage",id:"query-usage",level:3},{value:"Basic usage",id:"basic-usage",level:4},{value:"Extended esquery(field, QueryDSL)",id:"extended-esqueryfield-querydsl",level:4},{value:"Principle",id:"principle",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Suggestions for using Date type fields",id:"suggestions-for-using-date-type-fields",level:3},{value:"Fetch ES metadata field <code>_id</code>",id:"fetch-es-metadata-field-_id",level:3},{value:"Q&amp;A",id:"qa",level:2}],p={toc:s};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"doris-on-es"},"Doris On ES"),(0,r.kt)("p",null,"Doris-On-ES not only take advantage of Doris's distributed query planning capability but also ES (Elastic search)'s full-text search capability, provide a more complete OLAP scenario solution:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Multi-index Distributed Join Query in ES"),(0,r.kt)("li",{parentName:"ol"},"Joint Query of Tables in Doris and ES, More Complex Full-Text Retrieval and Filtering")),(0,r.kt)("p",null,"This document mainly introduces the realization principle and usage of this function."),(0,r.kt)("h2",{id:"glossary"},"Glossary"),(0,r.kt)("h3",{id:"noun-in-doris"},"Noun in Doris"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"FE: Frontend, the front-end node of Doris. Responsible for metadata management and request access."),(0,r.kt)("li",{parentName:"ul"},"BE: Backend, Doris's back-end node. Responsible for query execution and data storage.")),(0,r.kt)("h3",{id:"noun-in-es"},"Noun in ES"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DataNode: The data storage and computing node of ES."),(0,r.kt)("li",{parentName:"ul"},"MasterNode: The Master node of ES, which manages metadata, nodes, data distribution, etc."),(0,r.kt)("li",{parentName:"ul"},"scroll: The built-in data set cursor feature of ES for streaming scanning and filtering of data."),(0,r.kt)("li",{parentName:"ul"},"_source: contains the original JSON document body that was passed at index time"),(0,r.kt)("li",{parentName:"ul"},"doc_values: store the same values as the _source but in a column-oriented fashion"),(0,r.kt)("li",{parentName:"ul"},"keyword: string datatype in ES, but the content not analyzed by analyzer"),(0,r.kt)("li",{parentName:"ul"},"text: string datatype in ES, the content analyzed by analyzer")),(0,r.kt)("h2",{id:"how-to-use"},"How To Use"),(0,r.kt)("h3",{id:"create-es-index"},"Create ES Index"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'PUT test\n{\n   "settings": {\n      "index": {\n         "number_of_shards": "1",\n         "number_of_replicas": "0"\n      }\n   },\n   "mappings": {\n      "doc": { // There is no need to specify the type when creating indexes after ES7.x version, there is one and only type of `_doc`\n         "properties": {\n            "k1": {\n               "type": "long"\n            },\n            "k2": {\n               "type": "date"\n            },\n            "k3": {\n               "type": "keyword"\n            },\n            "k4": {\n               "type": "text",\n               "analyzer": "standard"\n            },\n            "k5": {\n               "type": "float"\n            }\n         }\n      }\n   }\n}\n')),(0,r.kt)("h3",{id:"add-json-documents-to-es-index"},"Add JSON documents to ES index"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'POST /_bulk\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Trying out Elasticsearch", "k4": "Trying out Elasticsearch", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Trying out Doris", "k4": "Trying out Doris", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Doris On ES", "k4": "Doris On ES", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Doris", "k4": "Doris", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "ES", "k4": "ES", "k5": 10.0}\n')),(0,r.kt)("h3",{id:"create-external-es-table"},"Create external ES table"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH // ENGINE must be Elasticsearch\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"type" = "doc",\n\n"user" = "root",\n"password" = "root"\n);\n')),(0,r.kt)("p",null,"The following parameters are accepted by ES table:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"hosts")),(0,r.kt)("td",{parentName:"tr",align:null},"ES Cluster Connection Address, maybe one or more node, load-balance is also accepted")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"index")),(0,r.kt)("td",{parentName:"tr",align:null},"the related ES index name, alias is supported, and if you use doc_value, you need to use the real name")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"type")),(0,r.kt)("td",{parentName:"tr",align:null},"the type for this index, If not specified, ",(0,r.kt)("inlineCode",{parentName:"td"},"_doc")," will be used")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"user")),(0,r.kt)("td",{parentName:"tr",align:null},"username for ES")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"password")),(0,r.kt)("td",{parentName:"tr",align:null},"password for the user")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"For clusters before 7.x, please pay attention to choosing the correct type when building the table"),(0,r.kt)("li",{parentName:"ul"},"The authentication method only supports Http Basic authentication, need to ensure that this user has access to: /","_","cluster/state/, ","_","nodes/http and other paths and index read permissions;The cluster has not turned on security authentication, and the user name and password do not need to be set"),(0,r.kt)("li",{parentName:"ul"},"The column names in the Doris table need to exactly match the field names in the ES, and the field types should be as consistent as possible"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"ENGINE")," must be: ",(0,r.kt)("strong",{parentName:"li"},"Elasticsearch"))),(0,r.kt)("h5",{id:"filter-to-push-down"},"Filter to push down"),(0,r.kt)("p",null,"An important ability of ",(0,r.kt)("inlineCode",{parentName:"p"},"Doris On ES")," is the push-down of filter conditions: The filtering conditions are pushed to ES, so that only the data that really meets the conditions will be returned, which can significantly improve query performance and reduce CPU, memory, and IO utilization of Doris and ES"),(0,r.kt)("p",null,"The following operators (Operators) will be optimized to the following ES Query:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"SQL syntax"),(0,r.kt)("th",{parentName:"tr",align:"center"},"ES 5.x+ syntax"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"="),(0,r.kt)("td",{parentName:"tr",align:"center"},"term query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"in"),(0,r.kt)("td",{parentName:"tr",align:"center"},"terms query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"> , < , >= , \u21d0"),(0,r.kt)("td",{parentName:"tr",align:"center"},"range query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"and"),(0,r.kt)("td",{parentName:"tr",align:"center"},"bool.filter")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"or"),(0,r.kt)("td",{parentName:"tr",align:"center"},"bool.should")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"not"),(0,r.kt)("td",{parentName:"tr",align:"center"},"bool.must_not")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"not in"),(0,r.kt)("td",{parentName:"tr",align:"center"},"bool.must_not + terms query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"is","_","not","_","null"),(0,r.kt)("td",{parentName:"tr",align:"center"},"exists query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"is","_","null"),(0,r.kt)("td",{parentName:"tr",align:"center"},"bool.must_not + exists query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"esquery"),(0,r.kt)("td",{parentName:"tr",align:"center"},"QueryDSL in ES native json form")))),(0,r.kt)("h5",{id:"data-type-mapping"},"Data type mapping"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Doris\\ES"),(0,r.kt)("th",{parentName:"tr",align:null},"byte"),(0,r.kt)("th",{parentName:"tr",align:null},"short"),(0,r.kt)("th",{parentName:"tr",align:null},"integer"),(0,r.kt)("th",{parentName:"tr",align:null},"long"),(0,r.kt)("th",{parentName:"tr",align:null},"float"),(0,r.kt)("th",{parentName:"tr",align:null},"double"),(0,r.kt)("th",{parentName:"tr",align:null},"keyword"),(0,r.kt)("th",{parentName:"tr",align:null},"text"),(0,r.kt)("th",{parentName:"tr",align:null},"date"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"tinyint"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"smallint"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"int"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"bigint"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"float"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"double"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"char"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"varchar"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"date"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"datetime"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u221a")))),(0,r.kt)("h3",{id:"enable-column-scan-to-optimize-query-speedenable_docvalue_scantrue"},"Enable column scan to optimize query speed(enable","_","docvalue","_","scan=true)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"type" = "doc",\n"user" = "root",\n"password" = "root",\n\n"enable_docvalue_scan" = "true"\n);\n')),(0,r.kt)("p",null,"Parameter Description:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"enable","_","docvalue","_","scan")),(0,r.kt)("td",{parentName:"tr",align:null},"whether to enable ES/Lucene column storage to get the value of the query field, the default is false")))),(0,r.kt)("p",null,"Doris obtains data from ES following the following two principles:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Best effort"),": Automatically detect whether the column to be read has column storage enabled (doc_value: true).If all the fields obtained have column storage, Doris will obtain the values \u200b\u200bof all fields from the column storage(doc_values)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Automatic downgrade"),": If the field to be obtained has one or more field that is not have doc_value, the values \u200b\u200bof all fields will be parsed from the line store ",(0,r.kt)("inlineCode",{parentName:"li"},"_source"))),(0,r.kt)("h5",{id:"advantage"},"Advantage:"),(0,r.kt)("p",null,"By default, Doris On ES will get all the required columns from the row storage, which is ",(0,r.kt)("inlineCode",{parentName:"p"},"_source"),", and the storage of ",(0,r.kt)("inlineCode",{parentName:"p"},"_source")," is the origin json format document, Inferior to column storage in batch read performance, Especially obvious when only a few columns are needed, When only a few columns are obtained, the performance of docvalue is about ten times that of _source"),(0,r.kt)("h5",{id:"tip"},"Tip"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Fields of type ",(0,r.kt)("inlineCode",{parentName:"li"},"text")," are not column-stored in ES, so if the value of the field to be obtained has a field of type ",(0,r.kt)("inlineCode",{parentName:"li"},"text"),", it will be automatically downgraded to get from ",(0,r.kt)("inlineCode",{parentName:"li"},"_source")),(0,r.kt)("li",{parentName:"ol"},"In the case of too many fields obtained (",(0,r.kt)("inlineCode",{parentName:"li"},">= 25"),"), the performance of getting field values \u200b\u200bfrom ",(0,r.kt)("inlineCode",{parentName:"li"},"docvalue")," will be basically the same as getting field values \u200b\u200bfrom ",(0,r.kt)("inlineCode",{parentName:"li"},"_source"))),(0,r.kt)("h3",{id:"detect-keyword-type-fieldenable_keyword_snifftrue"},"Detect keyword type field(enable","_","keyword","_","sniff=true)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"type" = "doc",\n"user" = "root",\n"password" = "root",\n\n"enable_keyword_sniff" = "true"\n);\n')),(0,r.kt)("p",null,"Parameter Description:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"enable","_","keyword","_","sniff")),(0,r.kt)("td",{parentName:"tr",align:null},"Whether to detect the string type (",(0,r.kt)("strong",{parentName:"td"},"text"),") ",(0,r.kt)("inlineCode",{parentName:"td"},"fields")," in ES to obtain additional not analyzed (",(0,r.kt)("strong",{parentName:"td"},"keyword"),") field name(multi-fields mechanism)")))),(0,r.kt)("p",null,"You can directly import data without creating an index. At this time, ES will automatically create a new index in ES, For a field of type string, a field of type ",(0,r.kt)("inlineCode",{parentName:"p"},"text")," and field of type ",(0,r.kt)("inlineCode",{parentName:"p"},"keyword")," will be created meantime, This is the multi-fields feature of ES, mapping is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"k4": {\n   "type": "text",\n   "fields": {\n      "keyword": {   \n         "type": "keyword",\n         "ignore_above": 256\n      }\n   }\n}\n')),(0,r.kt)("p",null,"When performing conditional filtering on k4, for example =, Doris On ES will convert the query to ES's TermQuery"),(0,r.kt)("p",null,"SQL filter:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'k4 = "Doris On ES"\n')),(0,r.kt)("p",null,"The query DSL converted into ES is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"term" : {\n    "k4": "Doris On ES"\n\n}\n')),(0,r.kt)("p",null,"Because the first field type of k4 is ",(0,r.kt)("inlineCode",{parentName:"p"},"text"),", when data is imported, it will perform word segmentation processing according to the word segmentator set by k4 (if it is not set, it is the standard word segmenter) to get three Term of doris, on, and es, as follows ES analyze API analysis: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'POST /_analyze\n{\n  "analyzer": "standard",\n  "text": "Doris On ES"\n}\n')),(0,r.kt)("p",null,"The result of analyzed is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n   "tokens": [\n      {\n         "token": "doris",\n         "start_offset": 0,\n         "end_offset": 5,\n         "type": "<ALPHANUM>",\n         "position": 0\n      },\n      {\n         "token": "on",\n         "start_offset": 6,\n         "end_offset": 8,\n         "type": "<ALPHANUM>",\n         "position": 1\n      },\n      {\n         "token": "es",\n         "start_offset": 9,\n         "end_offset": 11,\n         "type": "<ALPHANUM>",\n         "position": 2\n      }\n   ]\n}\n')),(0,r.kt)("p",null,"The query uses:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"term" : {\n    "k4": "Doris On ES"\n}\n')),(0,r.kt)("p",null,"This term does not match any term in the dictionary, and will not return any results, enable ",(0,r.kt)("inlineCode",{parentName:"p"},"enable_keyword_sniff: true")," will automatically convert ",(0,r.kt)("inlineCode",{parentName:"p"},'k4 = "Doris On ES"')," into ",(0,r.kt)("inlineCode",{parentName:"p"},'k4.keyword = "Doris On ES"'),"to exactly match SQL semantics, The converted ES query DSL is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"term" : {\n    "k4.keyword": "Doris On ES"\n}\n')),(0,r.kt)("p",null,"The type of ",(0,r.kt)("inlineCode",{parentName:"p"},"k4.keyword")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"keyword"),", and writing data into ES is a complete term, so it can be matched"),(0,r.kt)("h3",{id:"enable-node-discovery-mechanism-default-is-truees_nodes_discoverytrue"},"Enable node discovery mechanism, default is true(es","_","nodes","_","discovery=true)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test\u201d,\n"type" = "doc",\n"user" = "root",\n"password" = "root",\n\n"nodes_discovery" = "true"\n);\n')),(0,r.kt)("p",null,"Parameter Description\uff1a"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"es","_","nodes","_","discovery")),(0,r.kt)("td",{parentName:"tr",align:null},"Whether or not to enable ES node discovery. the default is true")))),(0,r.kt)("p",null,"Doris would find all available related data nodes (shards allocated on)from ES when this is true.  Just set false if address of  ES data nodes are not accessed by Doris BE, eg. the ES cluster is deployed in the intranet which isolated from your public Internet, and users access through a proxy"),(0,r.kt)("h3",{id:"whether-es-cluster-enables-https-access-mode-if-enabled-should-set-value-withtrue-default-is-falsehttp_ssl_enabletrue"},"Whether ES cluster enables https access mode, if enabled should set value with",(0,r.kt)("inlineCode",{parentName:"h3"},"true"),", default is false(http","_","ssl","_","enable=true)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test\u201d,\n"type" = "doc",\n"user" = "root",\n"password" = "root",\n\n"http_ssl_enabled" = "true"\n);\n')),(0,r.kt)("p",null,"Parameter Description\uff1a"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"http","_","ssl","_","enabled")),(0,r.kt)("td",{parentName:"tr",align:null},"Whether ES cluster enables https access mode")))),(0,r.kt)("p",null,"The current FE/BE implementation is to trust all, this is a temporary solution, and the real user configuration certificate will be used later"),(0,r.kt)("h3",{id:"query-usage"},"Query usage"),(0,r.kt)("p",null,"After create the ES external table in Doris, there is no difference except that the data model (rollup, pre-aggregation, materialized view, etc.) with other table in Doris"),(0,r.kt)("h4",{id:"basic-usage"},"Basic usage"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"select * from es_table where k1 > 1000 and k3 ='term' or k4 like 'fu*z_'\n")),(0,r.kt)("h4",{id:"extended-esqueryfield-querydsl"},"Extended esquery(field, QueryDSL)"),(0,r.kt)("p",null,"Through the ",(0,r.kt)("inlineCode",{parentName:"p"},"esquery(field, QueryDSL)")," function, some queries that cannot be expressed in sql, such as match_phrase, geoshape, etc., are pushed down to the ES for filtering. The first column name parameter of ",(0,r.kt)("inlineCode",{parentName:"p"},"esquery")," is used to associate the ",(0,r.kt)("inlineCode",{parentName:"p"},"index"),", the second This parameter is the basic JSON expression of ES's ",(0,r.kt)("inlineCode",{parentName:"p"},"Query DSL"),", which is contained in curly braces ",(0,r.kt)("inlineCode",{parentName:"p"},"{}"),", and there can be only one root key of json, such as match_phrase, geo_shape, bool, etc.\nMatch query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'select * from es_table where esquery(k4, \'{\n        "match": {\n           "k4": "doris on es"\n        }\n    }\');\n')),(0,r.kt)("p",null,"Geo related queries:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'select * from es_table where esquery(k4, \'{\n      "geo_shape": {\n         "location": {\n            "shape": {\n               "type": "envelope",\n               "coordinates": [\n                  [\n                     13,\n                     53\n                  ],\n                  [\n                     14,\n                     52\n                  ]\n               ]\n            },\n            "relation": "within"\n         }\n      }\n   }\');\n')),(0,r.kt)("p",null,"Bool query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'select * from es_table where esquery(k4, \' {\n         "bool": {\n            "must": [\n               {\n                  "terms": {\n                     "k1": [\n                        11,\n                        12\n                     ]\n                  }\n               },\n               {\n                  "terms": {\n                     "k2": [\n                        100\n                     ]\n                  }\n               }\n            ]\n         }\n      }\');\n')),(0,r.kt)("h2",{id:"principle"},"Principle"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"+----------------------------------------------+\n|                                              |\n| Doris      +------------------+              |\n|            |       FE         +--------------+-------+\n|            |                  |  Request Shard Location\n|            +--+-------------+-+              |       |\n|               ^             ^                |       |\n|               |             |                |       |\n|  +-------------------+ +------------------+  |       |\n|  |            |      | |    |             |  |       |\n|  | +----------+----+ | | +--+-----------+ |  |       |\n|  | |      BE       | | | |      BE      | |  |       |\n|  | +---------------+ | | +--------------+ |  |       |\n+----------------------------------------------+       |\n   |        |          | |        |         |          |\n   |        |          | |        |         |          |\n   |    HTTP SCROLL    | |    HTTP SCROLL   |          |\n+-----------+---------------------+------------+       |\n|  |        v          | |        v         |  |       |\n|  | +------+--------+ | | +------+-------+ |  |       |\n|  | |               | | | |              | |  |       |\n|  | |   DataNode    | | | |   DataNode   +<-----------+\n|  | |               | | | |              | |  |       |\n|  | |               +<--------------------------------+\n|  | +---------------+ | | |--------------| |  |       |\n|  +-------------------+ +------------------+  |       |\n|   Same Physical Node                         |       |\n|                                              |       |\n|           +-----------------------+          |       |\n|           |                       |          |       |\n|           |      MasterNode       +<-----------------+\n| ES        |                       |          |\n|           +-----------------------+          |\n+----------------------------------------------+\n\n\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"FE requests the hosts specified by the table to obtain node\u2018s HTTP port, shards location of the index. If the request fails, it will traverse the host list sequentially until it succeeds or fails completely.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When querying, the query plan will be generated and sent to the corresponding BE node according to some node information obtained by FE and metadata information of index.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The BE node requests locally deployed ES nodes in accordance with the ",(0,r.kt)("inlineCode",{parentName:"p"},"proximity principle"),". The BE receives data concurrently from each fragment of ES index in the ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP Scroll")," mode.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"After calculating the result, return it to client"))),(0,r.kt)("h2",{id:"best-practices"},"Best Practices"),(0,r.kt)("h3",{id:"suggestions-for-using-date-type-fields"},"Suggestions for using Date type fields"),(0,r.kt)("p",null,"The use of Datetype fields in ES is very flexible, but in Doris On ES, if the type of the Date type field is not set properly, it will cause the filter condition cannot be pushed down."),(0,r.kt)("p",null,"When creating an index, do maximum format compatibility with the setting of the Date type format:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},' "dt": {\n     "type": "date",\n     "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"\n }\n')),(0,r.kt)("p",null,"When creating this field in Doris, it is recommended to set it to ",(0,r.kt)("inlineCode",{parentName:"p"},"date")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"datetime"),", and it can also be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"varchar")," type. The following SQL statements can be used to directly push the filter condition down to ES"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"select * from doe where k2 > '2020-06-21';\n\nselect * from doe where k2 < '2020-06-21 12:00:00'; \n\nselect * from doe where k2 < 1593497011; \n\nselect * from doe where k2 < now();\n\nselect * from doe where k2 < date_format(now(), '%Y-%m-%d');\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Notice"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If you don\u2019t set the format for the time type field In ES, the default format for Date-type field is")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"strict_date_optional_time||epoch_millis\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the date field indexed into ES is unix timestamp, it needs to be converted to ",(0,r.kt)("inlineCode",{parentName:"li"},"ms"),", and the internal timestamp of ES is processed according to ",(0,r.kt)("inlineCode",{parentName:"li"},"ms")," unit, otherwise Doris On ES will display wrong column data")),(0,r.kt)("h3",{id:"fetch-es-metadata-field-_id"},"Fetch ES metadata field ",(0,r.kt)("inlineCode",{parentName:"h3"},"_id")),(0,r.kt)("p",null,"When indexing documents without specifying ",(0,r.kt)("inlineCode",{parentName:"p"},"_id"),", ES will assign a globally unique ",(0,r.kt)("inlineCode",{parentName:"p"},"_id")," field  to each document. Users can also specify a ",(0,r.kt)("inlineCode",{parentName:"p"},"_id")," with special represent some business meaning for the document when indexing; if needed, Doris On ES can get the value of this field by adding the ",(0,r.kt)("inlineCode",{parentName:"p"},"_id")," field of type ",(0,r.kt)("inlineCode",{parentName:"p"},"varchar")," when creating the ES external table"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'CREATE EXTERNAL TABLE `doe` (\n  `_id` varchar COMMENT "",\n  `city`  varchar COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://127.0.0.1:8200",\n"user" = "root",\n"password" = "root",\n"index" = "doe",\n"type" = "doc"\n}\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Notice"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The filtering condition of the ",(0,r.kt)("inlineCode",{parentName:"li"},"_id")," field only supports two types: ",(0,r.kt)("inlineCode",{parentName:"li"},"=")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"in")),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"_id")," field can only be of type ",(0,r.kt)("inlineCode",{parentName:"li"},"varchar"))),(0,r.kt)("h2",{id:"qa"},"Q&A"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"ES Version Requirements"),(0,r.kt)("p",{parentName:"li"},"The main version of ES is larger than 5. The scanning mode of ES data before 2. X and after 5. x is different. At present, the scanning mode of ES data after 5. x is supported.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Does ES Cluster Support X-Pack Authentication"),(0,r.kt)("p",{parentName:"li"},"Support all ES clusters using HTTP Basic authentication")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Some queries are much slower than requesting ES"),(0,r.kt)("p",{parentName:"li"},"Yes, for example, query related to _count, etc., the ES internal will directly read the number of documents that meet the requirements of the relevant metadata, without the need to filter the real data.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Whether the aggregation operation can be pushed down"),(0,r.kt)("p",{parentName:"li"},"At present, Doris On ES does not support push-down operations such as sum, avg, min/max, etc., all documents satisfying the conditions are obtained from the ES in batch flow, and then calculated in Doris"))))}u.isMDXComponent=!0}}]);