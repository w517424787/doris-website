"use strict";(self.webpackChunkselectdb_portal=self.webpackChunkselectdb_portal||[]).push([[27677],{3905:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>k});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var p=a.createContext({}),c=function(e){var t=a.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},d=function(e){var t=c(e.components);return a.createElement(p.Provider,{value:t},e.children)},s="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,p=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),s=c(r),m=n,k=s["".concat(p,".").concat(m)]||s[m]||u[m]||o;return r?a.createElement(k,i(i({ref:t},d),{},{components:r})):a.createElement(k,i({ref:t},d))}));function k(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[s]="string"==typeof e?e:n,i[1]=l;for(var c=2;c<o;c++)i[c]=r[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},9230:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>s,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=r(87462),n=(r(67294),r(3905));const o={title:"Construct Docker Image",language:"en"},i=void 0,l={unversionedId:"install/construct-docker/construct-docker-image",id:"install/construct-docker/construct-docker-image",title:"Construct Docker Image",description:"\x3c!--",source:"@site/docs/install/construct-docker/construct-docker-image.md",sourceDirName:"install/construct-docker",slug:"/install/construct-docker/construct-docker-image",permalink:"/docs/install/construct-docker/construct-docker-image",draft:!1,tags:[],version:"current",frontMatter:{title:"Construct Docker Image",language:"en"},sidebar:"docs",previous:{title:"Compilation With Arm",permalink:"/docs/install/source-install/compilation-arm"},next:{title:"Construct Docker Compose",permalink:"/docs/install/construct-docker/construct-docker-compose"}},p={},c=[{value:"Software and hardware requirements",id:"software-and-hardware-requirements",level:2},{value:"Overview",id:"overview",level:3},{value:"Hardware requirements",id:"hardware-requirements",level:3},{value:"Software Requirements",id:"software-requirements",level:3},{value:"Docker Image build",id:"docker-image-build",level:2},{value:"Script preparation",id:"script-preparation",level:3},{value:"Prepare binary package",id:"prepare-binary-package",level:3},{value:"Build Steps",id:"build-steps",level:3},{value:"Build FE",id:"build-fe",level:4},{value:"Build BE",id:"build-be",level:4},{value:"Build Broker",id:"build-broker",level:4},{value:"Push the image to DockerHub or private warehouse",id:"push-the-image-to-dockerhub-or-private-warehouse",level:2}],d={toc:c};function s(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"construct-docker-image"},"Construct Docker Image"),(0,n.kt)("p",null,"This document mainly introduces how to make a running image of Apache Doris through Dockerfile, so that an Apache Doris Image can be quickly pulled in a containerized orchestration tool or during a quick test to complete the cluster creation."),(0,n.kt)("h2",{id:"software-and-hardware-requirements"},"Software and hardware requirements"),(0,n.kt)("h3",{id:"overview"},"Overview"),(0,n.kt)("p",null,"Before making a Docker image, the production machine must be prepared in advance. The platform architecture of the machine determines the applicable platform architecture of the Docker Image after production. For example, the X86_64 machine needs to download the Doris binary program of X86_64. The image after production can only be used on the X86_64 platform run on. The ARM platform (M1 is regarded as ARM) is the same."),(0,n.kt)("h3",{id:"hardware-requirements"},"Hardware requirements"),(0,n.kt)("p",null,"Minimum configuration: 2C 4G"),(0,n.kt)("p",null,"Recommended configuration: 4C 16G"),(0,n.kt)("h3",{id:"software-requirements"},"Software Requirements"),(0,n.kt)("p",null,"Docker Version: 20.10 and later"),(0,n.kt)("h2",{id:"docker-image-build"},"Docker Image build"),(0,n.kt)("p",null,"Dockerfile scripting needs to pay attention to the following points:"),(0,n.kt)("blockquote",null,(0,n.kt)("ol",{parentName:"blockquote"},(0,n.kt)("li",{parentName:"ol"},"The base parent image uses the official OpenJDK image certified by Docker-Hub, and the version uses JDK 1.8"),(0,n.kt)("li",{parentName:"ol"},"The application uses the official binary package for download by default, do not use binary packages from unknown sources"),(0,n.kt)("li",{parentName:"ol"},"Embedded scripts are required to complete tasks such as FE startup, multi-FE registration, status check and BE startup, registration of BE to FE, status check, etc."),(0,n.kt)("li",{parentName:"ol"},"The application should not be started using ",(0,n.kt)("inlineCode",{parentName:"li"},"--daemon")," when starting in Docker, otherwise there will be exceptions during the deployment of orchestration tools such as K8S"))),(0,n.kt)("p",null,"Since Apache Doris 1.2 began to support JavaUDF capability, BE also needs a JDK environment. The recommended mirror is as follows:"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Doris Program"),(0,n.kt)("th",{parentName:"tr",align:null},"Recommended Base Parent Image"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"Frontend"),(0,n.kt)("td",{parentName:"tr",align:null},"openjdk:8u342-jdk")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"Backend"),(0,n.kt)("td",{parentName:"tr",align:null},"openjdk:8u342-jdk")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"Broker"),(0,n.kt)("td",{parentName:"tr",align:null},"openjdk:8u342-jdk")))),(0,n.kt)("h3",{id:"script-preparation"},"Script preparation"),(0,n.kt)("p",null,"In the Dockerfile script for compiling the Docker Image, there are two ways to load the binary package of the Apache Doris program:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Execute the download command at compile time via wget / curl, and then complete the docker build process"),(0,n.kt)("li",{parentName:"ol"},"Download the binary package to the compilation directory in advance, and then load it into the docker build process through the ADD or COPY command")),(0,n.kt)("p",null,"Using the former will make the Docker Image Size smaller, but if the build fails, the download operation may be repeated, resulting in a long build time, while the latter is more suitable for a build environment where the network environment is not very good. The image built by the latter is slightly larger than the former, but not much larger."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"To sum up, the examples in this document are subject to the second method. If you have the first request, you can customize and modify it according to your own needs. ")),(0,n.kt)("h3",{id:"prepare-binary-package"},"Prepare binary package"),(0,n.kt)("p",null,"It should be noted that if there is a need for customized development, you need to modify the source code and then ",(0,n.kt)("a",{parentName:"p",href:"../source-install/compilation"},"compile")," to package it, and then place it in the build directory."),(0,n.kt)("p",null,"If there is no special requirement, just ",(0,n.kt)("a",{parentName:"p",href:"https://doris.apache.org/download"},"download")," the binary package provided by the official website."),(0,n.kt)("h3",{id:"build-steps"},"Build Steps"),(0,n.kt)("h4",{id:"build-fe"},"Build FE"),(0,n.kt)("p",null,"The build environment directory is as follows:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"\u2514\u2500\u2500 docker-build                                       // build root directory\n     \u2514\u2500\u2500 fe                                            // FE build directory\n         \u251c\u2500\u2500 dockerfile                                // dockerfile script\n         \u2514\u2500\u2500 resource                                  // resource directory\n             \u251c\u2500\u2500 init_fe.sh                            // startup and registration script\n             \u2514\u2500\u2500 apache-doris-x.x.x-bin-fe.tar.gz      // binary package\n")),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Create a build environment directory"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir -p ./docker-build/fe/resource\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Download ",(0,n.kt)("a",{parentName:"p",href:"https://doris.apache.org/download"},"official binary package"),"/compiled binary package"),(0,n.kt)("p",{parentName:"li"},"Copy the binary package to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/fe/resource")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write FE's Dockerfile script"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-powershell"},'# select the base image\nFROM openjdk:8u342-jdk\n\n# Set environment variables\nENV JAVA_HOME="/usr/local/openjdk-8/" \\\n    PATH="/opt/apache-doris/fe/bin:$PATH"\n\n# Download the software to the mirror and replace it as needed\nADD ./resource/apache-doris-fe-${x.x.x}-bin.tar.gz /opt/\n\nRUN apt-get update && \\\n    apt-get install -y default-mysql-client && \\\n    apt-get clean && \\\n    mkdir /opt/apache-doris && \\\n    cd /opt && \\\n    mv apache-doris-fe-${x.x.x}-bin /opt/apache-doris/fe\n\nADD ./resource/init_fe.sh /opt/apache-doris/fe/bin\nRUN chmod 755 /opt/apache-doris/fe/bin/init_fe.sh\n\nENTRYPOINT ["/opt/apache-doris/fe/bin/init_fe.sh"]\n')),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/fe")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write the execution script of FE"),(0,n.kt)("p",{parentName:"li"},"You can refer to the content of copying ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/apache/doris/tree/master/docker/runtime/fe/resource/init_fe.sh"},"init_fe.sh")),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"init_fe.sh")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/fe/resouce")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Execute the build"),(0,n.kt)("p",{parentName:"li"},"It should be noted that ",(0,n.kt)("inlineCode",{parentName:"p"},"${tagName}")," needs to be replaced with the tag name you want to package and name, such as: ",(0,n.kt)("inlineCode",{parentName:"p"},"apache-doris:1.1.3-fe")),(0,n.kt)("p",{parentName:"li"},"Build FEs:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd ./docker-build/fe\ndocker build . -t ${fe-tagName}\n")))),(0,n.kt)("h4",{id:"build-be"},"Build BE"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Create a build environment directory")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir -p ./docker-build/be/resource\n")),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"The build environment directory is as follows:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"\u2514\u2500\u2500 docker-build                                            // build root directory\n    \u2514\u2500\u2500 be                                                  // BE build directory\n        \u251c\u2500\u2500 dockerfile                                      // dockerfile script\n        \u2514\u2500\u2500 resource                                        // resource directory\n            \u251c\u2500\u2500 init_be.sh                                  // startup and registration script\n            \u2514\u2500\u2500 apache-doris-x.x.x-bin-x86_64/arm-be.tar.gz // binary package\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write BE's Dockerfile script"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-powershell"},'# select the base image\nFROM openjdk:8u342-jdk\n\n# Set environment variables\nENV JAVA_HOME="/usr/local/openjdk-8/" \\\n    PATH="/opt/apache-doris/be/bin:$PATH"\n\n# Download the software to the mirror and replace it as needed\nADD ./resource/apache-doris-be-${x.x.x}-bin-x86_64.tar.gz /opt/\n\nRUN apt-get update && \\\n    apt-get install -y default-mysql-client && \\\n    apt-get clean && \\\n    mkdir /opt/apache-doris && \\\n    cd /opt && \\\n    mv apache-doris-be-${x.x.x}-bin-x86_64 /opt/apache-doris/be\n\nADD ./resource/init_be.sh /opt/apache-doris/be/bin\nRUN chmod 755 /opt/apache-doris/be/bin/init_be.sh\n\nENTRYPOINT ["/opt/apache-doris/be/bin/init_be.sh"]\n')),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/be")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write the execution script of BE"),(0,n.kt)("p",{parentName:"li"},"You can refer to the content of copying ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/apache/doris/tree/master/docker/runtime/be/resource/init_be.sh"},"init_be.sh")),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"init_be.sh")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/be/resouce")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Execute the build"),(0,n.kt)("p",{parentName:"li"},"It should be noted that ",(0,n.kt)("inlineCode",{parentName:"p"},"${tagName}")," needs to be replaced with the tag name you want to package and name, such as: ",(0,n.kt)("inlineCode",{parentName:"p"},"apache-doris:1.1.3-be")),(0,n.kt)("p",{parentName:"li"},"Build BEs:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd ./docker-build/be\ndocker build . -t ${be-tagName}\n")),(0,n.kt)("p",{parentName:"li"},"After the construction is complete, there will be a prompt of ",(0,n.kt)("inlineCode",{parentName:"p"},"Success"),". At this time, the following command can be used to view the Image mirror that has just been built"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker images\n")))),(0,n.kt)("h4",{id:"build-broker"},"Build Broker"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Create a build environment directory")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir -p ./docker-build/broker/resource\n")),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"The build environment directory is as follows:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"\u2514\u2500\u2500 docker-build                                     // build root directory\n    \u2514\u2500\u2500 broker                                       // BROKER build directory\n        \u251c\u2500\u2500 dockerfile                               // dockerfile script\n        \u2514\u2500\u2500 resource                                 // resource directory\n            \u251c\u2500\u2500 init_broker.sh                       // startup and registration script\n            \u2514\u2500\u2500 apache-doris-x.x.x-bin-broker.tar.gz // binary package\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write Broker's Dockerfile script"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-powershell"},'# select the base image\nFROM openjdk:8u342-jdk\n\n# Set environment variables\nENV JAVA_HOME="/usr/local/openjdk-8/" \\\n    PATH="/opt/apache-doris/broker/bin:$PATH"\n\n# Download the software to the mirror, where the broker directory is synchronously compressed to the binary package of FE, which needs to be decompressed and repackaged by itself, and can be replaced as needed\nADD ./resource/apache_hdfs_broker.tar.gz /opt/\n\nRUN apt-get update && \\\n    apt-get install -y default-mysql-client && \\\n    apt-get clean && \\\n    mkdir /opt/apache-doris && \\\n    cd /opt && \\\n    mv apache_hdfs_broker /opt/apache-doris/broker\n\nADD ./resource/init_broker.sh /opt/apache-doris/broker/bin\nRUN chmod 755 /opt/apache-doris/broker/bin/init_broker.sh\n\nENTRYPOINT ["/opt/apache-doris/broker/bin/init_broker.sh"]\n')),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/broker")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Write the execution script of BE"),(0,n.kt)("p",{parentName:"li"},"You can refer to the content of copying ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/apache/doris/tree/master/docker/runtime/broker/resource/init_broker.sh"},"init_broker.sh")),(0,n.kt)("p",{parentName:"li"},"After writing, name it ",(0,n.kt)("inlineCode",{parentName:"p"},"init_broker.sh")," and save it to the ",(0,n.kt)("inlineCode",{parentName:"p"},"./docker-build/broker/resouce")," directory")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Execute the build"),(0,n.kt)("p",{parentName:"li"},"It should be noted that ",(0,n.kt)("inlineCode",{parentName:"p"},"${tagName}")," needs to be replaced with the tag name you want to package and name, such as: ",(0,n.kt)("inlineCode",{parentName:"p"},"apache-doris:1.1.3-broker")),(0,n.kt)("p",{parentName:"li"},"Build Broker:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd ./docker-build/broker\ndocker build . -t ${broker-tagName}\n")),(0,n.kt)("p",{parentName:"li"},"After the construction is complete, there will be a prompt of ",(0,n.kt)("inlineCode",{parentName:"p"},"Success"),". At this time, the following command can be used to view the Image mirror that has just been built"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker images\n")))),(0,n.kt)("h2",{id:"push-the-image-to-dockerhub-or-private-warehouse"},"Push the image to DockerHub or private warehouse"),(0,n.kt)("p",null,"Log in to your DockerHub account"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"docker login\n")),(0,n.kt)("p",null,"A successful login will prompt ",(0,n.kt)("inlineCode",{parentName:"p"},"Success")," related prompts, and then push them to the warehouse"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker push ${tagName}\n")))}s.isMDXComponent=!0}}]);